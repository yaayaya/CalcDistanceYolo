# 距離恢復機制說明

## 問題描述

### 原始 BUG
當偵測人數 = 0 時，前端會收到 `distance = 0`，導致以下問題：
1. **未觸發停止延遲機制**：人離開瞬間，所有效果立即重置
2. **視覺效果突兀**：影像解析度、模糊效果等瞬間跳到初始狀態
3. **缺乏漸進恢復**：應該模擬人逐漸遠離，讓效果平滑過渡到最清晰狀態

## 解決方案

### 1. 配置檔案新增 (`project_config.json`)

新增 `distance_recovery` 區塊：

```json
{
  "distance_recovery": {
    "enabled": true,
    "deactivation_delay_ms": 1000,
    "recovery_duration_ms": 3000,
    "recovery_target_distance": 500,
    "recovery_easing": "ease-out"
  }
}
```

#### 參數說明
- **`enabled`**: 是否啟用距離恢復機制（預設：`true`）
- **`deactivation_delay_ms`**: 停止延遲時間（毫秒），人離開後延遲多久才開始恢復（預設：1000ms）
- **`recovery_duration_ms`**: 恢復持續時間（毫秒），從當前距離恢復到最大距離需要多久（預設：3000ms）
- **`recovery_target_distance`**: 恢復目標距離（cm），最終模擬的遠離距離（預設：500cm）
- **`recovery_easing`**: 緩動函數類型（預設：`ease-out`，快速開始，慢慢結束）

### 2. 後端 WebSocket 處理 (`websocket.py`)

#### 核心邏輯流程

```
人在範圍內 (distance > 0, count > 0)
   ↓
直接輸出真實距離
   ↓
人離開 (distance = 0 或 count = 0)
   ↓
進入「延遲期」(deactivation_delay_ms)
   ↓
保持最後有效距離不變
   ↓
延遲時間到達
   ↓
進入「恢復期」(recovery_duration_ms)
   ↓
距離從 last_valid_distance 逐步增加到 recovery_target_distance
   ↓
套用 ease-out 緩動，讓過渡更自然
   ↓
恢復完成，輸出最大距離（最清晰狀態）
```

#### 狀態變數
- `last_detection_time`: 最後一次有效偵測的時間戳
- `is_recovering`: 是否正在恢復狀態
- `recovery_start_time`: 開始恢復的時間戳
- `recovery_start_distance`: 開始恢復時的起始距離
- `last_valid_distance`: 最後一次有效的距離值

#### 緩動函數
使用 `ease-out` 緩動（二次方）：
```python
eased_progress = 1 - pow(1 - recovery_progress, 2)
```

### 3. 前端調整 (`flur.html`)

#### 主要變更
- **移除前端判斷邏輯**：後端已完整處理離開延遲與恢復，前端直接使用接收到的距離
- **保留平滑處理**：前端的平滑邏輯依然運作，讓畫面更流暢
- **除錯資訊增強**：顯示是否在恢復狀態，方便測試

```javascript
function handleDistanceData(data){
    // 後端已處理離開延遲與恢復機制
    targetDistance = data.distance || 0;
    const isRecovering = data.is_recovering || false;
    
    // 前端只負責平滑處理
    if(smoothedDistance === 0) smoothedDistance = targetDistance;
    
    const distanceDiff = Math.abs(targetDistance - smoothedDistance);
    if(distanceDiff > DISTANCE_CHANGE_THRESHOLD){
        smoothedDistance += (targetDistance - smoothedDistance) * DISTANCE_SMOOTH_SPEED;
    } else {
        smoothedDistance = targetDistance;
    }
    
    currentDistance = smoothedDistance;
}
```

### 4. API 端點新增 (`frontend.py`)

提供動態調整恢復機制的 API：

#### `GET /api/distance-recovery-config`
取得當前距離恢復機制配置

#### `PUT /api/distance-recovery-config`
更新距離恢復機制配置（可即時調整參數）

```json
{
  "enabled": true,
  "deactivation_delay_ms": 1500,
  "recovery_duration_ms": 2500,
  "recovery_target_distance": 500
}
```

## 效果展示

### 時間軸範例（假設配置：延遲 1s，恢復 3s）

```
時間 (秒) | 狀態          | 輸出距離 | 視覺效果
---------|--------------|---------|----------
0.0      | 人在前方      | 80 cm   | 模糊（距離近）
0.5      | 人在前方      | 75 cm   | 模糊
1.0      | 人離開！      | 75 cm   | 維持模糊（延遲期開始）
1.5      | 延遲期        | 75 cm   | 維持模糊
2.0      | 延遲期結束    | 75 cm   | 開始恢復！
2.5      | 恢復中 25%    | 181 cm  | 逐漸變清晰
3.0      | 恢復中 50%    | 287 cm  | 持續變清晰
3.5      | 恢復中 75%    | 393 cm  | 接近清晰
4.0      | 恢復中 100%   | 500 cm  | 完全清晰
5.0      | 恢復完成      | 500 cm  | 完全清晰（最遠距離）
```

## 調整建議

### 快速反應（適合展覽互動）
```json
{
  "deactivation_delay_ms": 500,
  "recovery_duration_ms": 2000
}
```

### 緩慢恢復（適合藝術表現）
```json
{
  "deactivation_delay_ms": 2000,
  "recovery_duration_ms": 5000
}
```

### 立即清晰（測試用）
```json
{
  "enabled": false
}
```
關閉恢復機制，人離開立即變清晰（輸出 distance = 0）

## 測試方式

1. **啟動系統**：
   ```bash
   python3.11 run.py
   ```

2. **開啟前端**：
   訪問 `http://localhost:8000/flur.html`

3. **開啟除錯模式**：
   按 `Ctrl + Shift + D` 開啟除錯面板

4. **測試流程**：
   - 站在攝影機前（應該看到距離值）
   - 快速離開畫面
   - 觀察距離是否：
     1. 先保持原值 1 秒（延遲期）
     2. 然後逐步增加到 500cm（恢復期 3 秒）
     3. 影像解析度同步從低→高
     4. 模糊效果同步從模糊→清晰

5. **動態調整參數**（可選）：
   ```bash
   curl -X PUT http://localhost:8000/api/distance-recovery-config \
     -H "Content-Type: application/json" \
     -d '{
       "enabled": true,
       "deactivation_delay_ms": 1500,
       "recovery_duration_ms": 2500,
       "recovery_target_distance": 500
     }'
   ```

## 技術細節

### 為什麼在後端處理？
1. **統一邏輯**：所有連接的前端（展覽、監控、其他裝置）都使用相同的恢復機制
2. **精確計時**：伺服器端計時更準確，不受前端效能影響
3. **易於調試**：可透過 API 即時調整參數，無需重新載入前端

### 為什麼保留前端平滑？
後端已經做了恢復，前端還需要平滑嗎？

**答案：需要！**
- 後端恢復：**大尺度的漸進變化**（1-3 秒從近距離到遠距離）
- 前端平滑：**小尺度的畫面穩定**（消除抖動、讓運動更流暢）
- 兩者結合：**完美的視覺體驗**

## 檔案變更清單

1. ✅ `backend/configs/project_config.json` - 新增 `distance_recovery` 配置
2. ✅ `backend/app/api/websocket.py` - 實作離開延遲與恢復邏輯
3. ✅ `frontend/flur.html` - 調整距離處理邏輯
4. ✅ `backend/app/api/frontend.py` - 新增配置管理 API
5. ✅ `docs/距離恢復機制說明.md` - 本文件

---

**修復完成日期**：2025-11-15  
**版本**：v1.0.0  
**作者**：GitHub Copilot
