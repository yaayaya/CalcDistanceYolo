# 速度插值快速設定指南

## 🚀 快速開始 (3 分鐘)

### 步驟 1: 啟動系統
```bash
cd backend
python main.py
```
等待看到: `Uvicorn running on http://0.0.0.0:8000`

### 步驟 2: 開啟管理介面
瀏覽器開啟: `http://localhost:8000/admin.html`

### 步驟 3: 設定速度插值
1. 點選左側選單「**距離偵測校準**」
2. 確認「**☑ 啟用三點插值模式**」已勾選
3. 設定三個點:
   ```
   點 1: 130 cm → 8.0x  (最近最快)
   點 2: 150 cm → 3.0x  (中間適中)
   點 3: 170 cm → 0.5x  (最遠最慢)
   ```
4. 點擊右上角「**儲存設定**」

### 步驟 4: 測試效果
開啟播放器: `http://localhost:8000/player.html`

按 `Ctrl+Shift+D` 開啟除錯模式,觀察:
- 偵測距離 (cm)
- 播放速度 (x)

---

## 📊 常用設定組合

### 組合 1: 標準互動模式
```
模式: 三點插值
點 1: 130cm → 8.0x
點 2: 150cm → 3.0x
點 3: 170cm → 0.5x
用途: 展覽、互動裝置
```

### 組合 2: 靈敏模式
```
模式: 三點插值
點 1: 100cm → 10.0x
點 2: 130cm → 5.0x
點 3: 160cm → 1.0x
用途: 快速反應展示
```

### 組合 3: 平緩模式
```
模式: 三點插值
點 1: 150cm → 5.0x
點 2: 200cm → 2.0x
點 3: 250cm → 0.5x
用途: 大空間、安靜展場
```

### 組合 4: 傳統雙點模式
```
模式: 雙點線性
最小距離: 130cm (對應最大速度 8.0x)
最大距離: 170cm (對應最小速度 0.5x)
用途: 簡單場景
```

---

## 🎯 速度插值運作原理

### 三點插值示意圖
```
距離(cm)  |  速度(x)  |  說明
---------|----------|-------------
  < 130  |   8.0    |  鎖定為點1速度
   130   |   8.0    |  點1 (最近最快)
   140   |   5.5    |  點1↔點2線性插值
   150   |   3.0    |  點2 (中間適中)
   160   |   1.75   |  點2↔點3線性插值
   170   |   0.5    |  點3 (最遠最慢)
  > 170  |   0.5    |  鎖定為點3速度
```

### 插值公式 (分段線性)
```javascript
// 區間 1: [點1, 點2]
if (distance >= p1.distance && distance <= p2.distance) {
    speed = p1.speed + (distance - p1.distance) * (p2.speed - p1.speed) / (p2.distance - p1.distance);
}

// 區間 2: [點2, 點3]
else if (distance > p2.distance && distance <= p3.distance) {
    speed = p2.speed + (distance - p2.distance) * (p3.speed - p2.speed) / (p3.distance - p2.distance);
}
```

---

## ⚙️ 進階調校參數

在「距離偵測校準」分頁下方「進階偵測參數」區塊:

| 參數 | 預設值 | 說明 | 調整建議 |
|------|--------|------|----------|
| **距離變化閾值** | 3 cm | 忽略小於此值的距離變化 | 增加可減少速度抖動 |
| **平滑係數** | 0.5 | 距離資料平滑強度 (0-1) | 增加可讓變化更平緩 |
| **啟動延遲** | 100 ms | 偵測到人後延遲開始調速 | 減少可提升反應速度 |
| **停用延遲** | 1000 ms | 人消失後延遲回復速度 | 增加可避免頻繁切換 |
| **無人臉逾時** | 3000 ms | 持續無人後回復基礎速度 | 展場建議 5000+ |

---

## 🐛 常見問題 & 解決

### Q1: 速度變化太突兀?
**解決方法**:
- 增加「平滑係數」至 0.7-0.8
- 增加「距離變化閾值」至 5-10
- 調整三個點的速度差距 (例如 8x → 5x → 2x)

### Q2: 反應太慢?
**解決方法**:
- 降低「啟動延遲」至 50 ms
- 降低「平滑係數」至 0.3
- 確認「transitionTime」為 0 (即時切換)

### Q3: 偵測不到人?
**解決方法**:
- 檢查攝影機是否正常運作
- 調整照明條件 (避免背光)
- 增加「最大距離」範圍
- 檢查 YOLO 模型是否正確載入

### Q4: 多人時速度混亂?
**解決方法**:
- 確認「多人時選取最近的人」已勾選
- 增加「距離變化閾值」減少跳動
- 考慮限制偵測區域 (需修改 detector.py)

---

## 🔍 除錯技巧

### 檢視即時狀態
在 player.html 按 `Ctrl+Shift+D` 開啟除錯模式

畫面會顯示:
```
偵測距離: 145.3 cm
播放速度: 4.25x
人臉數量: 1
FPS: 30
```

### 檢查設定檔
```bash
# Windows PowerShell
cat backend\configs\project_config.json | Select-String -Pattern "speedInterpolation" -Context 0,10

# 或直接開啟文件編輯器
notepad backend\configs\project_config.json
```

### 檢視 API 回應
```bash
# 使用 curl 或 PowerShell
Invoke-RestMethod http://localhost:8000/api/admin/config | ConvertTo-Json -Depth 10
```

---

## 📱 快捷鍵一覽

### player.html 播放頁面
- `Ctrl+Shift+D` - 切換除錯模式
- `Ctrl+Shift+E` - 切換展覽模式 (全螢幕)
- `Space` - 暫停/播放 (需先點擊畫面取得焦點)
- `F` - 全螢幕
- `M` - 靜音切換

### admin.html 管理頁面
- `Ctrl+S` - 儲存設定 (部分瀏覽器支援)
- `F5` - 重新載入設定

---

## 📖 延伸閱讀

- **完整遷移指南**: `docs/速度插值設定遷移指南.md`
- **專案結構說明**: `docs/專案結構.md`
- **API 文件**: `http://localhost:8000/docs`
- **原始實作摘要**: `docs/projectDoc/DistanceVideo_實作摘要.md`

---

## 💡 最佳實務

1. **展覽前測試**: 
   - 提前 1-2 天到場測試實際環境
   - 記錄最佳設定參數組合
   - 準備備用設定 (亮/暗環境各一組)

2. **環境因素考量**:
   - 光線: 明亮且均勻最佳,避免背光
   - 背景: 單純背景有助於偵測
   - 空間: 預留 1.5-3 公尺互動距離

3. **使用者體驗**:
   - 速度變化不宜過大 (建議最大 10 倍內)
   - 最慢速度避免低於 0.5x (避免停頓感)
   - 中間點設定為「舒適觀看速度」

4. **系統穩定性**:
   - 定期檢查 CPU/GPU 使用率
   - 監控 WebSocket 連線狀態
   - 準備無網路環境應變方案

---

**文件版本**: 1.0  
**最後更新**: 2025-11-09  
**適用版本**: DistanceVideo v2.0+
