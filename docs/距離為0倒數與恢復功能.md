# 距離為0倒數與恢復功能說明

## 功能概述

當系統偵測到距離為0（無人或人已離開）時，會啟動倒數機制，倒數結束後逐步恢復到清晰狀態。

## 運作流程

### 1. 正常偵測狀態
- 當偵測到人（距離 > 0）時，系統正常運作
- 根據距離動態調整模糊效果

### 2. 距離變為 0
- 當距離變為 0 時，開始倒數計時
- 倒數期間：保持當前模糊效果不變
- 倒數時間由 `deactivation_delay` 參數控制（預設 750ms）
- 前端除錯資訊顯示：`⏱ 倒數 X.Xs`

### 3. 倒數結束
- 進入「恢復模式」
- 目標距離（targetDistance）逐步降低到 0
- 使用指數衰減方式平滑恢復
- 前端除錯資訊顯示：`🔄 恢復中`

### 4. 完全恢復
- 當目標距離 < 0.5 時，直接設為 0
- 畫面完全清晰
- 前端除錯資訊顯示：`✅ 完全恢復到清晰狀態`

### 5. 重新偵測
- 如果在倒數期間或恢復期間重新偵測到人
- 立即中斷倒數/恢復流程
- 重置計時器，恢復正常偵測

## 參數設定

### 在 `project_config.json` 中設定

```json
{
  "blur_control": {
    "deactivation_delay": 750,    // 倒數時間（毫秒）
    "recovery_speed": 0.08,        // 恢復速度 (0.01=很慢, 0.2=很快)
    "activation_delay": 200,       // 啟動延遲（毫秒）
    "movement_threshold": 5        // 移動閾值（cm）
  }
}
```

### 在後台管理介面設定

訪問 `http://localhost:8000/flur_admin.html`

在「視訊模糊控制參數」區塊中：

1. **停止延遲 (ms)**
   - 範圍：0 - 2000ms
   - 預設：750ms
   - 說明：人體離開後延遲停止的時間（距離=0倒數時間）

2. **恢復速度**
   - 範圍：0.01 - 0.5
   - 預設：0.08
   - 說明：倒數結束後恢復到清晰的速度
   - 0.01 = 非常慢（需要較長時間恢復）
   - 0.08 = 中等速度（預設值）
   - 0.2 = 快速恢復

## 除錯資訊說明

在前端除錯模式下（按 Ctrl+Shift+D），距離顯示會包含狀態：

- `🟢 啟用` - 正常偵測中
- `⏱ 倒數 0.5s` - 距離=0，倒數中（顯示剩餘時間）
- `🔄 恢復中` - 倒數結束，正在逐步恢復清晰
- `⚪ 待機` - 等待啟動
- `✓` - 有效偵測（有人且距離 > 0）
- `✗` - 無效偵測（無人或距離 = 0）

## 數學原理

### 恢復速度計算

使用指數衰減方式：

```javascript
targetDistance -= targetDistance * RECOVERY_SPEED
```

- 當 `RECOVERY_SPEED = 0.08` 時：
  - 每幀減少當前值的 8%
  - 假設初始距離為 100cm：
    - 第1幀：100 - (100 × 0.08) = 92
    - 第2幀：92 - (92 × 0.08) = 84.64
    - 第3幀：84.64 - (84.64 × 0.08) = 77.87
    - ...持續衰減至接近 0

- 較小的值（如 0.01）：恢復緩慢，視覺上更平滑
- 較大的值（如 0.2）：恢復快速，更快回到清晰

### 平滑過渡

實際顯示的距離（smoothedDistance）會再經過一層平滑處理：

```javascript
smoothedDistance += (targetDistance - smoothedDistance) * DISTANCE_SMOOTH_SPEED
```

確保視覺效果流暢，避免突兀的變化。

## 使用建議

### 展覽環境
- `deactivation_delay`: 1000-1500ms（較長的倒數時間，避免誤觸）
- `recovery_speed`: 0.05-0.08（較慢的恢復，營造漸進的藝術效果）

### 互動展示
- `deactivation_delay`: 500-750ms（快速響應）
- `recovery_speed`: 0.1-0.15（中快速恢復）

### 測試環境
- `deactivation_delay`: 200-300ms（快速測試）
- `recovery_speed`: 0.2（快速恢復，方便測試）

## 故障排除

### 問題：倒數沒有觸發
- 檢查是否偵測器正在運行
- 確認 `deactivation_delay` 值是否正確載入
- 查看瀏覽器控制台是否有錯誤訊息

### 問題：恢復速度太慢/太快
- 調整 `recovery_speed` 參數
- 重新載入頁面使設定生效

### 問題：倒數被中斷
- 這是正常行為，當重新偵測到人時會中斷倒數
- 檢查攝影機範圍內是否有移動物體

## 技術實作

相關檔案：
- 前端邏輯：`frontend/flur_optimized.js`
- 後台設定：`frontend/flur_admin.html`
- 設定檔案：`backend/configs/project_config.json`

核心函式：
- `handleDistanceData()` - 處理距離資料與狀態管理
- `loadConfig()` - 載入設定參數
- `populateForm()` / `saveConfig()` - 後台介面的載入與儲存
