# 模糊圖層功能說明

## 功能概述

模糊圖層功能是為了解決低解析度時出現的馬賽克感問題，透過在 Canvas 上疊加半透明的模糊圖層，創造柔和的視覺效果。

## 技術原理

### 1. 距離映射
- 根據偵測距離動態調整模糊效果
- 距離越近 → 解析度越低 → 模糊效果越強
- 距離越遠 → 解析度越高 → 模糊效果減弱或消失

### 2. 多層繪製
- 使用多個半透明圖層疊加
- 每層的模糊半徑遞減，創造更自然的柔焦效果
- 預設使用 3 層，可調整為 1-10 層

### 3. Canvas 濾鏡
```javascript
ctx.filter = 'blur(8px)';           // 設定模糊半徑
ctx.globalAlpha = 0.1;              // 設定透明度
ctx.globalCompositeOperation = 'normal'; // 設定混合模式
```

## 配置參數說明

### project_config.json 新增區段

```json
{
  "blur_overlay": {
    "enabled": true,                // 是否啟用模糊圖層
    "min_distance": 70,             // 最小距離 (cm) - 模糊效果最強
    "max_distance": 120,            // 最大距離 (cm) - 模糊效果消失
    "min_blur_radius": 0,           // 最小模糊半徑 (px)
    "max_blur_radius": 8,           // 最大模糊半徑 (px)
    "min_opacity": 0,               // 最小透明度 (0-1)
    "max_opacity": 0.3,             // 最大透明度 (0-1)
    "overlay_color": "#888888",     // 圖層顏色
    "easing_function": "ease-out",  // 緩動函數
    "layer_count": 3,               // 圖層數量
    "blend_mode": "normal"          // 混合模式
  }
}
```

## 參數調整建議

### 自然柔焦效果
- **模糊半徑**: 6-8px
- **透明度**: 0.2-0.3
- **圖層數**: 3
- **混合模式**: normal
- **適用場景**: 展覽、藝術裝置

### 強烈藝術效果
- **模糊半徑**: 10-15px
- **透明度**: 0.3-0.5
- **圖層數**: 5
- **混合模式**: soft-light 或 overlay
- **適用場景**: 特殊視覺表演

### 效能優先設定
- **模糊半徑**: 3-5px
- **透明度**: 0.15-0.25
- **圖層數**: 2
- **混合模式**: normal
- **適用場景**: 低階硬體或需要高 FPS

## 緩動函數說明

| 函數 | 效果 | 適用場景 |
|------|------|----------|
| linear | 線性變化 | 均勻過渡 |
| ease-in | 開始慢後加速 | 漸進增強 |
| ease-out | 開始快後減速 | 自然減弱 (推薦) |
| ease-in-out | 兩端慢中間快 | 平滑過渡 |

## 混合模式效果

| 模式 | 視覺效果 | 說明 |
|------|----------|------|
| normal | 正常覆蓋 | 最自然的效果 |
| multiply | 色彩增值 | 顏色變深 |
| screen | 濾色 | 顏色變亮 |
| overlay | 覆蓋 | 增強對比 |
| soft-light | 柔光 | 柔和光暈效果 |

## 效能影響

### GPU 負載因素
1. **模糊半徑**: 半徑越大，計算量越高
2. **圖層數量**: 每增加一層，渲染次數增加
3. **解析度**: 低解析度時模糊計算較快

### 優化建議
- 在高 FPS 需求下，限制模糊半徑 ≤ 5px
- 圖層數量建議不超過 5 層
- 使用 `normal` 混合模式效能最佳
- 在 GPU 較弱的設備上可關閉此功能

## 使用方式

### 1. 開啟後台管理介面
訪問 `http://localhost:8000/flur_admin.html`

### 2. 調整模糊圖層參數
找到「🎨 模糊圖層效果」區段，調整以下參數：
- 啟用/關閉功能
- 設定觸發距離範圍
- 調整模糊強度和透明度
- 選擇圖層顏色和混合模式

### 3. 儲存並測試
- 點擊「💾 儲存設定」
- 開啟 `http://localhost:8000/flur.html` 測試效果
- 在除錯模式下可以看到即時的模糊參數

### 4. 即時除錯
按下 `Ctrl+Shift+D` 開啟除錯模式，可以看到：
- 當前距離
- 模糊半徑
- 圖層透明度
- FPS 影響

## 常見問題

### Q1: 看不到模糊效果？
**檢查項目**:
1. 確認 `enabled` 為 `true`
2. 確認當前距離在 `min_distance` 和 `max_distance` 範圍內
3. 確認 `max_blur_radius` 和 `max_opacity` 不為 0

### Q2: 效果太強或太弱？
**調整建議**:
- 太強: 降低 `max_opacity` 或 `max_blur_radius`
- 太弱: 提高 `max_opacity` 或 `max_blur_radius`

### Q3: FPS 下降嚴重？
**優化方案**:
1. 降低 `layer_count` 至 2
2. 降低 `max_blur_radius` 至 5 以下
3. 使用 `normal` 混合模式
4. 關閉動態解析度功能

### Q4: 顏色看起來不自然？
**建議顏色**:
- 中性灰: `#888888` (預設)
- 暖灰: `#998877`
- 冷灰: `#778899`
- 避免使用飽和度高的顏色

## 技術細節

### 繪製流程
1. 繪製原始影像到 Canvas
2. 檢查模糊圖層是否啟用
3. 計算當前距離對應的模糊參數
4. 使用緩動函數平滑過渡
5. 分層繪製半透明模糊圖層
6. 重設 Canvas 狀態

### 關鍵函式
- `drawBlurOverlay()`: 主要繪製邏輯
- `calculateNormalizedDistance()`: 距離正規化
- `applyEasing()`: 緩動函數計算
- `lerp()`: 線性插值

## 進階應用

### 自訂緩動曲線
可以在 `applyEasing()` 函式中加入更多緩動類型：
```javascript
case 'custom':
    return Math.pow(t, 3); // 三次方曲線
```

### 動態顏色變化
修改 `overlay_color` 可以根據距離或時間動態變化：
```javascript
const hue = normalizedDistance * 360;
ctx.fillStyle = `hsl(${hue}, 50%, 50%)`;
```

### 紋理圖層
可以替換純色填充為圖片紋理：
```javascript
const pattern = ctx.createPattern(textureImage, 'repeat');
ctx.fillStyle = pattern;
```

## 總結

模糊圖層功能提供了一個優雅的解決方案來改善低解析度畫面的視覺品質，透過後台管理介面可以靈活調整參數，在視覺效果和效能之間找到最佳平衡點。
