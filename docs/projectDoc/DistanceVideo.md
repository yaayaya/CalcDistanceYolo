# DistanceSpeed 專案規格書

## 專案概述

DistanceSpeed 是一個創新的多媒體互動裝置系統,能夠根據觀眾與螢幕的距離,透過人類距離偵測技術即時動態調整影片播放速度(1x～10x)。本版本精簡為單一螢幕單一影片的互動展示模式,移除多螢幕與多影片配置,聚焦於核心距離控制體驗。

## 核心功能

### 1. 距離偵測與速度控制

#### 多人處理機制
- **自動選取**: 當偵測到多人時,**自動選取距離最近的那一個**作為控制依據
- **距離與速度關聯**: 距離越近,播放速度越快;距離越遠,播放速度越慢
- **反向模式支援**: 距離越近播放越慢

#### 速度控制模式

##### 三點插值模式 (預設)
- **核心特性**: 即時響應,無延遲切換
- **設定方式**: 在後台管理介面設定三個距離控制點及對應速度
  - 點 1: 最近距離點 (例: 130cm → 8.0x)
  - 點 2: 中間距離點 (例: 150cm → 3.0x)
  - 點 3: 最遠距離點 (例: 170cm → 0.5x)
- **插值計算**: 
  - 偵測距離在兩點之間時,使用線性插值自動計算對應速度
  - 小於最近點時,使用最近點速度
  - 大於最遠點時,使用最遠點速度
- **優勢**: 提供更精細的速度控制曲線,可針對特定距離區間設定不同的速度變化率

##### 傳統雙點模式 (備用)
- **運作方式**: 使用 minDistance 和 maxDistance 定義距離範圍
- **速度計算**: 在範圍內線性映射到 minSpeed 和 maxSpeed
- **啟用方式**: 在後台管理介面停用三點插值模式即可切換

#### 即時響應機制
- **零延遲切換**: 偵測到距離變化時,影片播放速度立即改變
- **transitionTime**: 設定為 0,移除所有平滑過渡效果
- **activationDelay**: 可設定偵測後啟動延遲 (預設 0ms)
- **性能優化**: 使用 `playbackRate` 直接控制,避免動畫循環佔用資源

#### 緩衝與過濾機制
- **距離平滑**: 使用 smoothingFactor 過濾感測器噪音
- **人臉遺失處理**: 當持續 N 秒未偵測到人臉時,逐步降回基礎播放速度
- **停用延遲**: 無人臉時延遲 deactivationDelay 毫秒後才降速,避免短暫遮擋造成速度閃爍

### 2. 螢幕管理(單螢幕精簡版)
- **單一螢幕**: 僅保留一個展示螢幕 (screen_main)
- **影片綁定**: 直接綁定單一影片檔案至此螢幕
- **速度控制**: 播放速度完全由距離偵測結果統一控制
- **播放參數**: 支援循環播放(loop)、靜音(muted)、自動播放(autoplay) 基本參數
- 已移除: 多螢幕配置、跨螢幕指派、獨立參數集等功能

### 3. 顯示模式控制

#### 除錯模式 (Debug Mode)
- 顯示當前播放速度
- 顯示偵測到的距離(cm)
- 顯示人臉偵測框與數量
- 顯示攝影機畫面預覽
- 顯示 FPS 和處理延遲
	(單螢幕版本不再顯示螢幕編號)[1]

#### 展覽模式 (Exhibition Mode)
- 全螢幕影片播放
- 隱藏所有狀態資訊和 UI 元素
- 自動隱藏滑鼠游標
- 提供切換模式的隱藏熱鍵(如: Ctrl+Shift+S)[1]

### 4. 影片管理系統

#### 上傳功能
- 支援格式: MP4, WebM, OGG
- 自動產生縮圖預覽

#### 影片列表
- 顯示已上傳影片清單
- 提供播放、刪除功能
- 顯示影片資訊(檔名、大小、時長、解析度)
- 已移除螢幕指派與使用標示[1]

#### 播放設定
- 單螢幕播放影片設定: 選擇影片、循環播放(loop)、靜音(muted)、自動播放(autoplay)
- 已移除刪除螢幕與多螢幕選擇流程

## 後台管理功能模組 (project_config.json)

- 當參數更新需有提示是否更新成功
- 設定頁面精簡: 單一影片設定頁面保留預覽影片功能

## 前端效能優化

### 記憶體管理(8小時穩定運行關鍵)
- 事件監聽器清理:確保所有 addEventListener 都有對應的 removeEventListener
- SSE 連線管理:頁面離開時正確關閉 EventSource 連線
- 定時器清理:所有 setInterval 和 setTimeout 都要在組件銷毀時清除
- requestAnimationFrame 管理:使用 cancelAnimationFrame 停止不必要的動畫循環
- 響應式資料優化:僅對需要觸發 UI 更新的資料使用 Vue 響應式系統
- 使用 shallowRef:對於大型物件或不需要深度追蹤的資料使用淺層響應式[1]

### 影片播放優化
- 格式選擇:優先使用 WebM (VP9) 格式,Chrome 長時間播放最穩定
- 解析度限制:建議使用 1920x1080,避免 4K 造成記憶體負擔
- 位元率控制:5-8 Mbps 平衡品質與效能
- preload 設定:使用 `preload="auto"` 完整預載影片
- 影片資源釋放:切換影片時正確釋放舊影片的記憶體資源
- 硬體加速:確保瀏覽器啟用硬體解碼加速[1]

### 渲染效能
- 使用 requestAnimationFrame:所有動畫更新與瀏覽器繪製週期同步,保持 60 FPS
- 避免強制同步佈局:減少讀取 DOM 幾何屬性後立即修改樣式的操作
- CSS 動畫優先:盡可能使用 CSS transition 而非 JavaScript 動畫
- 減少重繪範圍:使用 will-change 屬性提示瀏覽器優化特定元素[1]

## 技術架構

- **核心**: HTML5 + Vue.js 3 (CDN 引入)
