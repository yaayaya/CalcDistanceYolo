<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DistanceVideo Player</title>
    <link rel="stylesheet" href="/css/player.css">
    <script src="/cdn/axios.min.js"></script>
</head>
<body>
    <div id="player-app">
        <!-- å½±ç‰‡æ’­æ”¾å™¨ -->
        <video 
            id="main-video" 
            class="main-video"
            playsinline
        ></video>

        <!-- é™¤éŒ¯è³‡è¨Šé¢æ¿ -->
        <div id="debug-panel" class="debug-panel" style="display:none;">
            <div class="debug-header">
                <h3>ğŸ” é™¤éŒ¯è³‡è¨Š</h3>
                <button id="btn-close-debug" class="btn-close">âœ•</button>
            </div>
            
            <div id="row-speed" class="debug-item">
                <span class="label">æ’­æ”¾é€Ÿåº¦:</span>
                <span id="val-speed" class="value">1.00x</span>
            </div>

            <div id="row-distance" class="debug-item">
                <span class="label">åµæ¸¬è·é›¢:</span>
                <span id="val-distance" class="value">0.0 cm</span>
            </div>

            <div id="row-face" class="debug-item">
                <span class="label">äººè‡‰æ•¸é‡:</span>
                <span id="val-face" class="value">0</span>
            </div>

            <div id="row-fps" class="debug-item">
                <span class="label">FPS:</span>
                <span id="val-fps" class="value">0</span>
            </div>

            <div id="row-conn" class="debug-item">
                <span class="label">é€£ç·šç‹€æ…‹:</span>
                <span id="val-conn" class="value disconnected">æœªé€£ç·š</span>
            </div>

            <div id="row-uptime" class="debug-item">
                <span class="label">é‹è¡Œæ™‚é–“:</span>
                <span id="val-uptime" class="value">00:00:00</span>
            </div>
        </div>

        <!-- æ”å½±æ©Ÿé è¦½ -->
        <div id="camera-preview" class="camera-preview" style="display:none;">
            <canvas id="preview-canvas"></canvas>
        </div>

        <!-- å¿«æ·éµæç¤º -->
        <div id="hotkey-hint" class="hotkey-hint" style="display:none;">
            <p>Ctrl+Shift+D: åˆ‡æ›é™¤éŒ¯æ¨¡å¼</p>
            <p>Ctrl+Shift+E: åˆ‡æ›å±•è¦½æ¨¡å¼</p>
        </div>
    </div>

    <script src="/js/api-client.js"></script>
    <script>
        // DistanceVideo Player ä¸»æ‡‰ç”¨
        const app = {
            // é…ç½®
            config: {
                video: {
                    currentVideo: '',
                    baseSpeed: 1.0,
                    maxSpeed: 10.0,
                    minSpeed: 0.25,
                    loop: true,
                    muted: false,
                    autoplay: true,
                    transitionTime: 0,
                    reverseMode: false,
                    speedControlMode: 'interpolation'
                },
                speedInterpolation: {
                    enabled: true,
                    points: [
                        { distance: 130, speed: 8.0 },
                        { distance: 150, speed: 3.0 },
                        { distance: 170, speed: 0.5 }
                    ]
                },
                distance: {
                    minDistance: 50,
                    maxDistance: 500,
                    closestPersonMode: true,
                    distanceThreshold: 10,
                    smoothingFactor: 0.3,
                    activationDelay: 300,
                    deactivationDelay: 1000,
                    noFaceTimeout: 3000
                },
                display: {
                    debugMode: false,
                    showSpeed: true,
                    showDistance: true,
                    showFaceCount: true,
                    showFPS: true,
                    showCameraPreview: false,
                    cursorHideDelay: 2000,
                    exhibitionMode: false
                }
            },

            // ç‹€æ…‹
            state: {
                currentSpeed: 1.0,
                targetSpeed: 1.0,
                closestDistance: 0,
                prevDistance: 0,
                rawDistance: 0,
                faceCount: 0,
                fps: 0,
                connectionStatus: 'æœªé€£ç·š',
                uptime: '00:00:00',
                startTime: null,
                ws: null,
                video: null,
                lastFaceTime: null,
                activationTimer: null,
                deactivationTimer: null,
                speedTransition: null,
                cursorTimer: null,
                showHint: false,
                playAttempted: false,
                videoReady: false
            },

            // åˆå§‹åŒ–
            async init() {
                console.log('ğŸš€ åˆå§‹åŒ– DistanceVideo Player...');
                
                // å–å¾—å½±ç‰‡å…ƒç´ 
                this.state.video = document.getElementById('main-video');
                console.log('ğŸ“º å½±ç‰‡å…ƒç´ :', this.state.video);
                
                // è¼‰å…¥é…ç½®
                await this.loadConfig();
                console.log('âš™ï¸ é…ç½®å·²è¼‰å…¥:', this.config);
                
                // è¨­å®šå½±ç‰‡æº
                this.updateVideoSrc();
                
                // ä¾é…ç½®è¨­å®šå½±ç‰‡å±¬æ€§
                this.state.video.loop = !!this.config.video.loop;
                this.state.video.muted = !!this.config.video.muted;
                this.state.video.autoplay = !!this.config.video.autoplay;
                console.log('ğŸ“ å½±ç‰‡å±¬æ€§å·²è¨­å®š:', {
                    loop: this.state.video.loop,
                    muted: this.state.video.muted,
                    autoplay: this.state.video.autoplay
                });
                
                // ç¶å®šäº‹ä»¶
                this.bindEvents();
                
                // å•Ÿå‹•è¨ˆæ™‚å™¨
                this.startTimers();
                
                // ç­‰å¾…å½±ç‰‡æº–å‚™å¥½å¾Œå†å»ºç«‹ WebSocket (é¿å…ç«¶çˆ­)
                this.state.video.addEventListener('loadedmetadata', () => {
                    console.log('âœ… å½±ç‰‡å…ƒè³‡æ–™å·²è¼‰å…¥');
                    console.log('   å½±ç‰‡é•·åº¦:', this.state.video.duration, 'ç§’');
                    console.log('   å½±ç‰‡è§£æåº¦:', this.state.video.videoWidth, 'x', this.state.video.videoHeight);
                    this.connectWebSocket();
                }, { once: true });
                
                // è‹¥å·²æœ‰å…ƒè³‡æ–™å‰‡ç«‹å³é€£ç·š
                if (this.state.video.readyState >= 1) {
                    console.log('â„¹ï¸ å½±ç‰‡å·²æœ‰å…ƒè³‡æ–™ï¼Œç«‹å³é€£ç·š WebSocket');
                    this.connectWebSocket();
                }
                
                console.log('âœ… åˆå§‹åŒ–å®Œæˆ');
            },

            // è¼‰å…¥é…ç½®
            async loadConfig() {
                try {
                    console.log('ğŸ“¥ æ­£åœ¨è¼‰å…¥é…ç½®...');
                    const response = await apiClient.getConfig();
                    this.config = response.data;
                    console.log('âœ… é…ç½®å·²è¼‰å…¥:', this.config);
                    
                    // é©—è­‰é€Ÿåº¦æ’å€¼é…ç½®
                    if (this.config.speedInterpolation) {
                        console.log('ğŸ“ˆ é€Ÿåº¦æ’å€¼é…ç½®:', this.config.speedInterpolation);
                        if (this.config.speedInterpolation.enabled) {
                            console.log('âœ“ ä¸‰é»æ’å€¼æ¨¡å¼å·²å•Ÿç”¨');
                            console.log('  é» 1:', this.config.speedInterpolation.points[0]);
                            console.log('  é» 2:', this.config.speedInterpolation.points[1]);
                            console.log('  é» 3:', this.config.speedInterpolation.points[2]);
                        } else {
                            console.log('âœ“ ä½¿ç”¨å‚³çµ±é›™é»æ¨¡å¼');
                        }
                    }
                    
                    this.updateUI();
                } catch (error) {
                    console.error('âŒ è¼‰å…¥é…ç½®å¤±æ•—:', error);
                }
            },

            // æ›´æ–°å½±ç‰‡æº
            updateVideoSrc() {
                if (this.config.video.currentVideo) {
                    const videoSrc = `/videos/${this.config.video.currentVideo}`;
                    console.log('ğŸ¬ è¨­å®šå½±ç‰‡æº:', videoSrc);
                    
                    this.state.video.src = videoSrc;
                    
                    // è¼‰å…¥å½±ç‰‡
                    this.state.video.load();
                    
                    // ç›£è½å½±ç‰‡äº‹ä»¶
                    this.state.video.addEventListener('loadstart', () => {
                        console.log('ğŸ“¥ å½±ç‰‡é–‹å§‹è¼‰å…¥...');
                    }, { once: true });
                    
                    this.state.video.addEventListener('canplay', () => {
                        console.log('âœ… å½±ç‰‡å¯ä»¥æ’­æ”¾');
                        this.state.videoReady = true;
                        this.tryAutoPlay();
                    }, { once: true });
                    
                    this.state.video.addEventListener('loadedmetadata', () => {
                        console.log('ğŸ“‹ å½±ç‰‡å…ƒè³‡æ–™å·²è¼‰å…¥');
                        this.state.videoReady = true;
                        this.tryAutoPlay();
                    }, { once: true });
                    
                    this.state.video.addEventListener('error', (e) => {
                        console.error('âŒ å½±ç‰‡è¼‰å…¥éŒ¯èª¤:', e);
                        console.error('   éŒ¯èª¤ä»£ç¢¼:', this.state.video.error?.code);
                        console.error('   éŒ¯èª¤è¨Šæ¯:', this.state.video.error?.message);
                    }, { once: true });
                } else {
                    console.warn('âš ï¸ æœªè¨­å®š currentVideo');
                }
            },
            
            // å˜—è©¦è‡ªå‹•æ’­æ”¾
            tryAutoPlay() {
                if (this.state.playAttempted || !this.state.videoReady) {
                    return;
                }
                
                this.state.playAttempted = true;
                
                console.log('â–¶ï¸ å˜—è©¦è‡ªå‹•æ’­æ”¾å½±ç‰‡...');
                const playPromise = this.state.video.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('âœ… å½±ç‰‡è‡ªå‹•æ’­æ”¾æˆåŠŸ');
                        })
                        .catch(err => {
                            console.warn('âš ï¸ è‡ªå‹•æ’­æ”¾è¢«é˜»æ“‹:', err.message);
                            // é¡¯ç¤ºé»æ“Šæç¤º
                            this.showPlayPrompt();
                        });
                }
            },
            
            // é¡¯ç¤ºæ’­æ”¾æç¤º
            showPlayPrompt() {
                // å‰µå»ºé»æ“Šæç¤ºè¦†è“‹å±¤
                const overlay = document.createElement('div');
                overlay.id = 'play-prompt';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                    cursor: pointer;
                `;
                
                const message = document.createElement('div');
                message.style.cssText = `
                    background: white;
                    padding: 30px 50px;
                    border-radius: 10px;
                    font-size: 20px;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;
                message.innerHTML = 'â–¶ï¸<br>é»æ“Šè¢å¹•é–‹å§‹æ’­æ”¾';
                
                overlay.appendChild(message);
                document.body.appendChild(overlay);
                
                // é»æ“Šå¾Œæ’­æ”¾ä¸¦ç§»é™¤æç¤º
                overlay.addEventListener('click', () => {
                    this.state.video.play()
                        .then(() => {
                            console.log('âœ… ä½¿ç”¨è€…äº’å‹•å¾Œæ’­æ”¾æˆåŠŸ');
                            overlay.remove();
                        })
                        .catch(err => {
                            console.error('âŒ æ’­æ”¾å¤±æ•—:', err);
                        });
                });
            },

            // å»ºç«‹ WebSocket é€£ç·š
            connectWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/detection`;
                
                console.log('é€£ç·š WebSocket:', wsUrl);
                this.state.connectionStatus = 'é€£ç·šä¸­...';
                this.updateUI();
                
                this.state.ws = new WebSocket(wsUrl);
                
                this.state.ws.onopen = () => {
                    console.log('âœ… WebSocket å·²é€£ç·š');
                    this.state.connectionStatus = 'å·²é€£ç·š';
                    this.state.startTime = Date.now();
                    this.updateUI();
                };
                
                this.state.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleDetectionData(data);
                };
                
                this.state.ws.onerror = (error) => {
                    console.error('âŒ WebSocket éŒ¯èª¤:', error);
                    this.state.connectionStatus = 'é€£ç·šéŒ¯èª¤';
                    this.updateUI();
                };
                
                this.state.ws.onclose = () => {
                    console.log('â¹ WebSocket å·²æ–·ç·š');
                    this.state.connectionStatus = 'æœªé€£ç·š';
                    this.updateUI();
                    
                    // 5ç§’å¾Œå˜—è©¦é‡é€£
                    setTimeout(() => this.connectWebSocket(), 5000);
                };
            },

            // è™•ç†åµæ¸¬è³‡æ–™
            handleDetectionData(data) {
                // æ›´æ–°ç‹€æ…‹
                this.state.faceCount = data.total_count || 0;
                this.state.fps = data.actual_fps || 0;
                
                // å–å¾—æœ€è¿‘è·é›¢
                const rawDistance = data.closest_distance || 0;
                
                // Debug: è¨˜éŒ„æ”¶åˆ°çš„è³‡æ–™
                if (this.state.faceCount > 0) {
                    console.log(`ğŸ“¡ æ”¶åˆ°åµæ¸¬è³‡æ–™: äººè‡‰=${this.state.faceCount}, åŸå§‹è·é›¢=${rawDistance.toFixed(1)}cm, FPS=${this.state.fps}`);
                }
                
                // å„²å­˜ä¸Šä¸€æ¬¡çš„å¹³æ»‘è·é›¢ç”¨æ–¼é–¾å€¼æ¯”è¼ƒ
                const prevDistance = this.state.closestDistance;
                
                // è·é›¢å¹³æ»‘è™•ç†
                if (this.state.closestDistance === 0) {
                    this.state.closestDistance = rawDistance;
                } else {
                    const factor = this.config.distance.smoothingFactor;
                    this.state.closestDistance = 
                        this.state.closestDistance * (1 - factor) + rawDistance * factor;
                }
                
                // è¨˜éŒ„åŸå§‹è·é›¢ä¾›é–¾å€¼æ¯”è¼ƒ
                this.state.prevDistance = prevDistance;
                this.state.rawDistance = rawDistance;
                
                // æ ¹æ“šè·é›¢è¨ˆç®—ç›®æ¨™é€Ÿåº¦
                this.calculateTargetSpeed();
                
                // æ›´æ–° UI
                this.updateUI();
            },

            // è¨ˆç®—ç›®æ¨™é€Ÿåº¦ (ä¸‰é»ç·šæ€§æ’å€¼)
            calculateTargetSpeed() {
                const distance = this.state.closestDistance;
                
                // ç„¡äººæˆ–è·é›¢ç‚º 0
                if (this.state.faceCount === 0 || distance === 0) {
                    console.log('ğŸš« ç„¡äººè‡‰æˆ–è·é›¢ç‚º0ï¼Œè™•ç†ç„¡äººè‡‰æƒ…æ³');
                    this.handleNoFace();
                    return;
                }
                
                // è¨˜éŒ„æœ€å¾Œåµæ¸¬åˆ°äººè‡‰çš„æ™‚é–“
                this.state.lastFaceTime = Date.now();
                
                let targetSpeed = this.config.video.baseSpeed;
                
                // ä½¿ç”¨ä¸‰é»æ’å€¼æ¨¡å¼
                if (this.config.speedInterpolation && this.config.speedInterpolation.enabled) {
                    const points = this.config.speedInterpolation.points;
                    
                    // ç¢ºä¿æœ‰ä¸‰å€‹é»ä¸”å·²æ’åº
                    if (points && points.length >= 3) {
                        // æŒ‰è·é›¢æ’åº
                        const sortedPoints = [...points].sort((a, b) => a.distance - b.distance);
                        const p1 = sortedPoints[0];  // æœ€è¿‘è·é›¢é»
                        const p2 = sortedPoints[1];  // ä¸­é–“è·é›¢é»
                        const p3 = sortedPoints[2];  // æœ€é è·é›¢é»
                        
                        if (distance <= p1.distance) {
                            // å°æ–¼ç­‰æ–¼æœ€è¿‘é»: ä½¿ç”¨æœ€è¿‘é»é€Ÿåº¦
                            targetSpeed = p1.speed;
                        } else if (distance >= p3.distance) {
                            // å¤§æ–¼ç­‰æ–¼æœ€é é»: ä½¿ç”¨æœ€é é»é€Ÿåº¦
                            targetSpeed = p3.speed;
                        } else if (distance <= p2.distance) {
                            // åœ¨æœ€è¿‘é»å’Œä¸­é–“é»ä¹‹é–“: ç·šæ€§æ’å€¼
                            const ratio = (distance - p1.distance) / (p2.distance - p1.distance);
                            targetSpeed = p1.speed + (p2.speed - p1.speed) * ratio;
                        } else {
                            // åœ¨ä¸­é–“é»å’Œæœ€é é»ä¹‹é–“: ç·šæ€§æ’å€¼
                            const ratio = (distance - p2.distance) / (p3.distance - p2.distance);
                            targetSpeed = p2.speed + (p3.speed - p2.speed) * ratio;
                        }
                        
                        console.log(`ğŸ¯ ä¸‰é»æ’å€¼ | è·é›¢: ${distance.toFixed(1)}cm | P1(${p1.distance}cm,${p1.speed}x) P2(${p2.distance}cm,${p2.speed}x) P3(${p3.distance}cm,${p3.speed}x) â†’ é€Ÿåº¦: ${targetSpeed.toFixed(2)}x`);
                    }
                } else {
                    // å›é€€åˆ°å‚³çµ±é›™é»æ¨¡å¼
                    const { minDistance, maxDistance } = this.config.distance;
                    const { maxSpeed, minSpeed, reverseMode } = this.config.video;
                    
                    let ratio = 0;
                    if (distance <= minDistance) {
                        ratio = 1;
                    } else if (distance >= maxDistance) {
                        ratio = 0;
                    } else {
                        // ç·šæ€§æ’å€¼ï¼šè·é›¢è¶Šè¿‘ï¼Œæ¯”ä¾‹è¶Šå¤§
                        ratio = 1 - (distance - minDistance) / (maxDistance - minDistance);
                    }
                    
                    if (reverseMode) {
                        // åå‘æ¨¡å¼: è·é›¢è¿‘æ’­æ”¾æ…¢
                        targetSpeed = minSpeed + (maxSpeed - minSpeed) * (1 - ratio);
                    } else {
                        // æ­£å¸¸æ¨¡å¼: è·é›¢è¿‘æ’­æ”¾å¿«
                        targetSpeed = minSpeed + (maxSpeed - minSpeed) * ratio;
                    }
                    
                    console.log(`ğŸ¯ å‚³çµ±æ¨¡å¼ | è·é›¢: ${distance.toFixed(1)}cm | ç¯„åœ: ${minDistance}-${maxDistance}cm | æ¯”ä¾‹: ${(ratio * 100).toFixed(0)}% | é€Ÿåº¦: ${targetSpeed.toFixed(2)}x`);
                }
                
                // é™åˆ¶é€Ÿåº¦ç¯„åœ
                const { minSpeed, maxSpeed } = this.config.video;
                targetSpeed = Math.max(minSpeed, Math.min(maxSpeed, targetSpeed));
                
                this.state.targetSpeed = targetSpeed;
                
                // æ¸…é™¤åœç”¨è¨ˆæ™‚å™¨
                if (this.state.deactivationTimer) {
                    clearTimeout(this.state.deactivationTimer);
                    this.state.deactivationTimer = null;
                }
                
                // å³æ™‚åˆ‡æ›é€Ÿåº¦ (ä¸ä½¿ç”¨å¹³æ»‘éæ¸¡)
                this.applySpeedInstantly(targetSpeed);
            },

            // è™•ç†ç„¡äººè‡‰æƒ…æ³
            handleNoFace() {
                if (!this.state.lastFaceTime) return;
                
                const timeSinceLastFace = Date.now() - this.state.lastFaceTime;
                
                if (timeSinceLastFace > this.config.distance.noFaceTimeout) {
                    // æ¸…é™¤å•Ÿå‹•è¨ˆæ™‚å™¨
                    if (this.state.activationTimer) {
                        clearTimeout(this.state.activationTimer);
                        this.state.activationTimer = null;
                    }
                    
                    // è¨­å®šåœç”¨è¨ˆæ™‚å™¨
                    if (!this.state.deactivationTimer) {
                        this.state.deactivationTimer = setTimeout(() => {
                            this.transitionSpeed(this.config.video.baseSpeed);
                            this.state.deactivationTimer = null;
                        }, this.config.distance.deactivationDelay);
                    }
                }
            },

            // å³æ™‚å¥—ç”¨é€Ÿåº¦ (ç„¡å¹³æ»‘éæ¸¡)
            applySpeedInstantly(targetSpeed) {
                // å–æ¶ˆä»»ä½•é€²è¡Œä¸­çš„é€Ÿåº¦éæ¸¡
                if (this.state.speedTransition) {
                    cancelAnimationFrame(this.state.speedTransition);
                    this.state.speedTransition = null;
                }
                
                // å–æ¶ˆå•Ÿå‹•è¨ˆæ™‚å™¨
                if (this.state.activationTimer) {
                    clearTimeout(this.state.activationTimer);
                    this.state.activationTimer = null;
                }
                
                // å³æ™‚è¨­å®šé€Ÿåº¦
                this.state.currentSpeed = targetSpeed;
                this.state.video.playbackRate = targetSpeed;
                
                console.log(`âš¡ å³æ™‚åˆ‡æ›é€Ÿåº¦: ${targetSpeed.toFixed(2)}x`);
                
                // æ›´æ–° UI
                this.updateUI();
            },

            // ä¿ç•™å¹³æ»‘éæ¸¡å‡½å¼ä¾›ç‰¹æ®Šæƒ…æ³ä½¿ç”¨ (ä¾‹å¦‚ç„¡äººè‡‰å›å¾©åŸºç¤é€Ÿåº¦)
            transitionSpeed(targetSpeed) {
                if (this.state.speedTransition) {
                    cancelAnimationFrame(this.state.speedTransition);
                }
                
                const startSpeed = this.state.currentSpeed;
                const startTime = Date.now();
                const duration = this.config.video.transitionTime;
                
                console.log(`ğŸ¬ é–‹å§‹é€Ÿåº¦è½‰æ›: ${startSpeed.toFixed(2)}x â†’ ${targetSpeed.toFixed(2)}x (${duration}ms)`);
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Ease-out æ›²ç·š
                    const eased = 1 - Math.pow(1 - progress, 3);
                    
                    this.state.currentSpeed = startSpeed + (targetSpeed - startSpeed) * eased;
                    this.state.video.playbackRate = this.state.currentSpeed;
                    
                    if (progress < 1) {
                        this.state.speedTransition = requestAnimationFrame(animate);
                    } else {
                        this.state.speedTransition = null;
                        console.log(`âœ… é€Ÿåº¦è½‰æ›å®Œæˆ: ç•¶å‰é€Ÿåº¦=${this.state.currentSpeed.toFixed(2)}x, playbackRate=${this.state.video.playbackRate.toFixed(2)}x`);
                    }
                    
                    this.updateUI();
                };
                
                animate();
            },

            // æ›´æ–° UI
            updateUI() {
                // æ›´æ–°æ‰€æœ‰é™¤éŒ¯è³‡è¨Š
                this.updateDebugPanel();
            },

            // æ›´æ–°é™¤éŒ¯é¢æ¿
            updateDebugPanel() {
                const show = (el, visible) => {
                    if (!el) return;
                    el.style.display = visible ? '' : 'none';
                };

                const panel = document.getElementById('debug-panel');
                show(panel, this.config.display.debugMode && !this.config.display.exhibitionMode);

                // è¡Œç‚ºåˆ‡æ›
                const rowSpeed = document.getElementById('row-speed');
                const rowDistance = document.getElementById('row-distance');
                const rowFace = document.getElementById('row-face');
                const rowFps = document.getElementById('row-fps');

                show(rowSpeed, !!this.config.display.showSpeed);
                show(rowDistance, !!this.config.display.showDistance);
                show(rowFace, !!this.config.display.showFaceCount);
                show(rowFps, !!this.config.display.showFPS);

                // å€¼æ›´æ–°
                const valSpeed = document.getElementById('val-speed');
                const valDistance = document.getElementById('val-distance');
                const valFace = document.getElementById('val-face');
                const valFps = document.getElementById('val-fps');
                const valConn = document.getElementById('val-conn');
                const valUptime = document.getElementById('val-uptime');

                if (valSpeed) valSpeed.textContent = `${this.state.currentSpeed.toFixed(2)}x`;
                if (valDistance) {
                    const d = this.state.closestDistance || 0;
                    valDistance.textContent = `${d.toFixed(1)} cm`;
                    valDistance.classList.remove('danger', 'warning', 'safe');
                    const distance = d;
                    let cls = '';
                    if (distance === 0) cls = '';
                    else if (distance < 150) cls = 'danger';
                    else if (distance < 300) cls = 'warning';
                    else cls = 'safe';
                    if (cls) valDistance.classList.add(cls);
                }
                if (valFace) valFace.textContent = String(this.state.faceCount);
                if (valFps) valFps.textContent = String(Math.round(this.state.fps));

                if (valConn) {
                    valConn.textContent = this.state.connectionStatus;
                    valConn.classList.remove('connected', 'disconnected');
                    valConn.classList.add(this.state.connectionStatus === 'å·²é€£ç·š' ? 'connected' : 'disconnected');
                }
                if (valUptime) valUptime.textContent = this.state.uptime;

                // æ”å½±æ©Ÿé è¦½é¡¯ç¤º
                const cam = document.getElementById('camera-preview');
                show(cam, !!this.config.display.showCameraPreview && !!this.config.display.debugMode);

                // å¿«æ·éµæç¤º
                const hint = document.getElementById('hotkey-hint');
                show(hint, !!this.state.showHint);
            },

            // ç¶å®šäº‹ä»¶
            bindEvents() {
                // å¿«æ·éµ
                document.addEventListener('keydown', (e) => {
                    // Ctrl+Shift+D: åˆ‡æ›é™¤éŒ¯æ¨¡å¼
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        e.preventDefault();
                        this.config.display.debugMode = !this.config.display.debugMode;
                        this.updateUI();
                    }
                    
                    // Ctrl+Shift+E: åˆ‡æ›å±•è¦½æ¨¡å¼
                    if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                        e.preventDefault();
                        this.toggleExhibitionMode();
                    }
                });
                
                // æ»‘é¼ ç§»å‹• - æ¸¸æ¨™éš±è—
                document.addEventListener('mousemove', () => {
                    document.body.style.cursor = 'default';
                    
                    if (this.state.cursorTimer) {
                        clearTimeout(this.state.cursorTimer);
                    }
                    
                    this.state.cursorTimer = setTimeout(() => {
                        if (this.config.display.exhibitionMode) {
                            document.body.style.cursor = 'none';
                        }
                    }, this.config.display.cursorHideDelay);
                });
            },

            // åˆ‡æ›å±•è¦½æ¨¡å¼
            toggleExhibitionMode() {
                this.config.display.exhibitionMode = !this.config.display.exhibitionMode;
                
                if (this.config.display.exhibitionMode) {
                    // é€²å…¥å…¨è¢å¹•
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    }
                    document.body.style.cursor = 'none';
                } else {
                    // é€€å‡ºå…¨è¢å¹•
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                    document.body.style.cursor = 'default';
                }
                
                this.updateUI();
            },

            // åˆ‡æ›é™¤éŒ¯æ¨¡å¼
            toggleDebug() {
                this.config.display.debugMode = false;
                this.updateUI();
            },

            // å•Ÿå‹•è¨ˆæ™‚å™¨
            startTimers() {
                // é‹è¡Œæ™‚é–“æ›´æ–°
                setInterval(() => {
                    if (this.state.startTime) {
                        const elapsed = Math.floor((Date.now() - this.state.startTime) / 1000);
                        const hours = Math.floor(elapsed / 3600);
                        const minutes = Math.floor((elapsed % 3600) / 60);
                        const seconds = elapsed % 60;
                        
                        this.state.uptime = 
                            `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        
                        this.updateUI();
                    }
                }, 1000);
                
                // é¡¯ç¤ºå¿«æ·éµæç¤º (3ç§’å¾Œæ¶ˆå¤±)
                this.state.showHint = true;
                setTimeout(() => {
                    this.state.showHint = false;
                }, 3000);
            },

            // è¨ˆç®—è·é›¢é¡è‰²é¡åˆ¥
            get distanceClass() {
                const distance = this.state.closestDistance;
                if (distance === 0) return '';
                if (distance < 150) return 'danger';
                if (distance < 300) return 'warning';
                return 'safe';
            },

            // è¨ˆç®—é€£ç·šç‹€æ…‹é¡åˆ¥
            get connectionStatusClass() {
                return this.state.connectionStatus === 'å·²é€£ç·š' ? 'connected' : 'disconnected';
            },

            // è¨ˆç®—å½±ç‰‡æº
            get videoSrc() {
                return this.config.video.currentVideo 
                    ? `/videos/${this.config.video.currentVideo}` 
                    : '';
            }
        };

        // å•Ÿå‹•æ‡‰ç”¨
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            // é—œé–‰é™¤éŒ¯é¢æ¿æŒ‰éˆ•
            const closeBtn = document.getElementById('btn-close-debug');
            if (closeBtn) closeBtn.addEventListener('click', () => app.toggleDebug());
            
            // å°‡ app æš´éœ²åˆ°å…¨åŸŸä¾›é™¤éŒ¯ä½¿ç”¨
            window.playerApp = app;
        });
    </script>
</body>
</html>
