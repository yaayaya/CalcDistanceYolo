<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlurPaint - 互動藝術裝置</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        #display-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover; /* 填滿整個螢幕，避免黑邊和跳動 */
            image-rendering: pixelated; /* 低解析度時保持像素化效果 */
            transform: translateZ(0); /* 啟用 GPU 加速，減少抖動 */
            will-change: auto; /* 避免過度優化導致的問題 */
        }

        /* 除錯資訊覆蓋層 */
        #debug-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border-radius: 8px;
            z-index: 1000;
            display: none; /* 預設隱藏 */
            pointer-events: none;
        }

        #debug-overlay.active {
            display: block;
        }

        #debug-overlay .debug-item {
            margin: 5px 0;
        }

        #debug-overlay .debug-label {
            color: #0ff;
        }

        #debug-overlay .debug-value {
            color: #fff;
            font-weight: bold;
        }

        /* 連線狀態指示器 */
        #connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }

        #connection-status.connecting {
            background: #f59e0b;
            color: #fff;
            display: block;
        }

        #connection-status.connected {
            background: #10b981;
            color: #fff;
            display: block;
            animation: fadeOut 2s forwards;
        }

        #connection-status.disconnected {
            background: #ef4444;
            color: #fff;
            display: block;
        }

        @keyframes fadeOut {
            0%, 80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                display: none;
            }
        }

        /* 展覽模式說明 */
        #exhibition-info {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            text-align: center;
            z-index: 1000;
            animation: pulse 2s infinite;
            display: none; /* 預設隱藏 */
        }

        #exhibition-info.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Canvas 顯示區 -->
    <div id="canvas-container">
        <canvas id="display-canvas"></canvas>
    </div>

    <!-- 除錯資訊覆蓋層 -->
    <div id="debug-overlay">
        <div class="debug-item">
            <span class="debug-label">連線狀態:</span>
            <span class="debug-value" id="debug-connection">未連線</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">偵測距離:</span>
            <span class="debug-value" id="debug-distance">-- cm</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">偵測人數:</span>
            <span class="debug-value" id="debug-count">0</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">目標解析度:</span>
            <span class="debug-value" id="debug-resolution">-- x --</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">當前解析度:</span>
            <span class="debug-value" id="debug-current-res">-- x --</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">FPS:</span>
            <span class="debug-value" id="debug-fps">--</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">JPEG 品質:</span>
            <span class="debug-value" id="debug-quality">--</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">模糊半徑:</span>
            <span class="debug-value" id="debug-blur">--</span>
        </div>
        <div class="debug-item">
            <span class="debug-label">圖層透明度:</span>
            <span class="debug-value" id="debug-opacity">--</span>
        </div>
    </div>

    <!-- 連線狀態指示器 -->
    <div id="connection-status">連線中...</div>

    <!-- 展覽模式說明 -->
    <div id="exhibition-info">
        請靠近或遠離感應器,體驗影像解析度的變化
    </div>

    <script>
        // ===== 全域變數 =====
        let ws = null;
        let config = null;
        let canvas = null;
        let ctx = null;
        
        // 當前影像解析度 (從後端接收)
        let currentResolution = { width: 1920, height: 1080 };
        
        // 當前距離與模糊參數
        let currentDistance = 0;
        let currentBlurRadius = 0;
        let currentOpacity = 0;
        
        // FPS 計算
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let currentFps = 0;

        // ===== 初始化 =====
        document.addEventListener('DOMContentLoaded', async () => {
            canvas = document.getElementById('display-canvas');
            ctx = canvas.getContext('2d', { alpha: false });
            
            // 載入配置
            await loadConfig();
            
            // 套用顯示設定
            applyDisplaySettings();
            
            // 建立 WebSocket 連線
            connectWebSocket();
            
            // 繫定熱鍵
            bindHotkeys();
        });

        // ===== 載入配置 =====
        async function loadConfig() {
            try {
                const response = await fetch('/api/project-config');
                const result = await response.json();
                
                if (result.status === 'success') {
                    config = result.data;
                    console.log('✅ 配置已載入:', config);
                } else {
                    console.error('❌ 載入配置失敗');
                    useDefaultConfig();
                }
            } catch (error) {
                console.error('❌ 載入配置錯誤:', error);
                useDefaultConfig();
            }
        }

        function useDefaultConfig() {
            config = {
                blur_control: {
                    min_resolution_width: 320,
                    max_resolution_width: 1920,
                    acceleration_time: 500,
                    deceleration_time: 1000,
                    movement_threshold: 10,
                    activation_delay: 200,
                    deactivation_delay: 500,
                    sample_rate: 30
                },
                distance_mapping: {
                    min_distance: 50,
                    max_distance: 500,
                    easing_function: "linear"
                },
                display: {
                    debug_mode: false,
                    exhibition_mode: true,
                    show_fps: false,
                    show_distance: false
                },
                blur_overlay: {
                    enabled: true,
                    min_distance: 70,
                    max_distance: 120,
                    min_blur_radius: 0,
                    max_blur_radius: 8,
                    min_opacity: 0,
                    max_opacity: 0.3,
                    overlay_color: "#888888",
                    easing_function: "ease-out",
                    layer_count: 3,
                    blend_mode: "normal"
                }
            };
        }

        // ===== 套用顯示設定 =====
        function applyDisplaySettings() {
            const debugOverlay = document.getElementById('debug-overlay');
            const exhibitionInfo = document.getElementById('exhibition-info');
            
            if (config.display.debug_mode) {
                debugOverlay.classList.add('active');
                exhibitionInfo.classList.remove('active');
            } else if (config.display.exhibition_mode) {
                debugOverlay.classList.remove('active');
                exhibitionInfo.classList.add('active');
            } else {
                debugOverlay.classList.remove('active');
                exhibitionInfo.classList.remove('active');
            }
        }

        // ===== WebSocket 連線 =====
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/flur`;
            
            updateConnectionUI('connecting');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('✅ WebSocket 已連線');
                    updateConnectionUI('connected');
                    updateDebugInfo('connection', '已連線');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleFrameData(data);
                };
                
                ws.onerror = (error) => {
                    console.error('❌ WebSocket 錯誤:', error);
                    updateConnectionUI('disconnected');
                    updateDebugInfo('connection', '連線錯誤');
                };
                
                ws.onclose = () => {
                    console.log('⏹ WebSocket 已斷線');
                    updateConnectionUI('disconnected');
                    updateDebugInfo('connection', '未連線');
                    
                    // 5秒後自動重連
                    setTimeout(connectWebSocket, 5000);
                };
                
            } catch (error) {
                console.error('❌ 建立 WebSocket 失敗:', error);
                updateConnectionUI('disconnected');
            }
        }

        // ===== 處理影像幀資料 =====
        function handleFrameData(data) {
            if (data.type !== 'frame_data') return;
            
            // 更新當前距離
            currentDistance = data.distance || 0;
            
            // 更新當前解析度 (從後端接收)
            if (data.resolution) {
                currentResolution = {
                    width: data.resolution.width,
                    height: data.resolution.height
                };
            }
            
            // 更新除錯資訊
            updateDebugInfo('distance', `${data.distance.toFixed(1)} cm`);
            updateDebugInfo('count', data.total_count || 0);
            updateDebugInfo('resolution', `${currentResolution.width} x ${currentResolution.height}`);
            updateDebugInfo('quality', data.quality || '--');
            
            // 解碼並繪製影像
            const img = new Image();
            img.onload = () => {
                drawFrame(img);
                
                // 計算 FPS
                frameCount++;
                const now = Date.now();
                if (now - lastFpsUpdate >= 1000) {
                    currentFps = frameCount;
                    frameCount = 0;
                    lastFpsUpdate = now;
                    updateDebugInfo('fps', currentFps);
                }
            };
            img.src = 'data:image/jpeg;base64,' + data.image;
        }

        // ===== 繪製影像幀 =====
        function drawFrame(img) {
            // 檢查是否需要更新 Canvas 尺寸
            if (canvas.width !== currentResolution.width || canvas.height !== currentResolution.height) {
                // 立即更新尺寸，不使用動畫或過渡
                canvas.width = currentResolution.width;
                canvas.height = currentResolution.height;
            }
            
            // 清除之前的內容（避免殘影）
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製新影像，填滿整個 Canvas
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // 繪製模糊圖層（如果啟用）
            if (config.blur_overlay && config.blur_overlay.enabled) {
                drawBlurOverlay();
            }
            
            // 更新除錯資訊
            updateDebugInfo('current-res', `${canvas.width} x ${canvas.height}`);
        }

        // ===== 繪製模糊圖層 =====
        function drawBlurOverlay() {
            const overlay = config.blur_overlay;
            
            // 計算當前距離對應的模糊參數
            const normalizedDistance = calculateNormalizedDistance(
                currentDistance,
                overlay.min_distance,
                overlay.max_distance
            );
            
            // 使用緩動函數
            const easedValue = applyEasing(normalizedDistance, overlay.easing_function);
            
            // 計算模糊半徑和透明度（距離越近，模糊越強）
            currentBlurRadius = lerp(overlay.max_blur_radius, overlay.min_blur_radius, easedValue);
            currentOpacity = lerp(overlay.max_opacity, overlay.min_opacity, easedValue);
            
            // 更新除錯資訊
            updateDebugInfo('blur', `${currentBlurRadius.toFixed(1)} px`);
            updateDebugInfo('opacity', `${(currentOpacity * 100).toFixed(1)}%`);
            
            // 只在有效果時繪製
            if (currentBlurRadius > 0 && currentOpacity > 0) {
                // 多層繪製以增強柔和效果
                const layerCount = overlay.layer_count || 3;
                const opacityPerLayer = currentOpacity / layerCount;
                
                for (let i = 0; i < layerCount; i++) {
                    ctx.save();
                    
                    // 設定混合模式
                    ctx.globalCompositeOperation = overlay.blend_mode || 'normal';
                    ctx.globalAlpha = opacityPerLayer;
                    
                    // 設定模糊濾鏡
                    const blurPerLayer = currentBlurRadius * (1 - i / layerCount * 0.3);
                    ctx.filter = `blur(${blurPerLayer}px)`;
                    
                    // 繪製半透明色塊
                    ctx.fillStyle = overlay.overlay_color || '#888888';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.restore();
                }
                
                // 重設濾鏡和透明度
                ctx.filter = 'none';
                ctx.globalAlpha = 1.0;
                ctx.globalCompositeOperation = 'source-over';
            }
        }

        // ===== 計算正規化距離 (0-1) =====
        function calculateNormalizedDistance(distance, minDist, maxDist) {
            if (distance <= minDist) return 0;
            if (distance >= maxDist) return 1;
            return (distance - minDist) / (maxDist - minDist);
        }

        // ===== 緩動函數 =====
        function applyEasing(t, easingType) {
            switch (easingType) {
                case 'linear':
                    return t;
                case 'ease-in':
                    return t * t;
                case 'ease-out':
                    return 1 - Math.pow(1 - t, 2);
                case 'ease-in-out':
                    return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
                default:
                    return t;
            }
        }

        // ===== 線性插值 =====
        function lerp(start, end, t) {
            return start + (end - start) * t;
        }

        // ===== 更新連線狀態 UI =====
        function updateConnectionUI(status) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = status;
            
            const statusText = {
                'connecting': '連線中...',
                'connected': '已連線',
                'disconnected': '連線中斷'
            };
            
            statusElement.textContent = statusText[status] || '未知狀態';
        }

        // ===== 更新除錯資訊 =====
        function updateDebugInfo(key, value) {
            const element = document.getElementById(`debug-${key}`);
            if (element) {
                element.textContent = value;
            }
        }

        // ===== 綁定熱鍵 =====
        function bindHotkeys() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+Shift+D: 切換除錯模式
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    config.display.debug_mode = !config.display.debug_mode;
                    applyDisplaySettings();
                    e.preventDefault();
                }
                
                // Ctrl+Shift+E: 切換展覽模式
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    config.display.exhibition_mode = !config.display.exhibition_mode;
                    applyDisplaySettings();
                    e.preventDefault();
                }
            });
        }
    </script>
</body>
</html>
