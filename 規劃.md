## 計畫:YOLO11 距離偵測 FastAPI MVC 專案 (最終版)

完整的三層架構展覽系統 — 本地執行,手動刷新配置,單前端連線。

**TL;DR**: 建立 FastAPI 後端讀取 config.json 執行 YOLO 偵測,透過 WebSocket 即時推送距離資料;後台可監控當前數據並透過 `network_config.json` 設定 WebSocket 參數(手動刷新生效);前端透過標準化 API 取得距離資訊。

**步驟:**

1. **建立專案結構** - 標準 MVC 分層:
   ```
   project/
   ├── app/
   │   ├── __init__.py
   │   ├── main.py                    # FastAPI 應用入口
   │   ├── models/
   │   │   ├── __init__.py
   │   │   └── schemas.py             # Pydantic 資料模型
   │   ├── services/
   │   │   ├── __init__.py
   │   │   ├── calculator.py          # 距離計算器 (複用 DistanceCalculator)
   │   │   ├── detector.py            # YOLO 偵測服務 (async generator)
   │   │   └── connection_manager.py  # WebSocket 連線管理
   │   ├── api/
   │   │   ├── __init__.py
   │   │   ├── websocket.py           # WebSocket 端點
   │   │   └── frontend.py            # RESTful API 端點
   │   └── utils/
   │       ├── __init__.py
   │       └── config_loader.py       # 配置載入工具
   ├── admin/
   │   ├── index.html                 # 後台監控介面
   │   ├── style.css
   │   └── script.js
   ├── configs/
   │   ├── config.json                # 偵測參數 (GUI工具調整,唯讀)
   │   └── network_config.json        # 網路設定 (後台調整,可寫)
   ├── requirements.txt
   └── README.md
   ```

2. **實作核心偵測服務** - `app/services/detector.py`:
   - 實作 `YOLODetectorService` 類別,初始化時載入 YOLO 模型和 config.json
   - 實作 `async def detection_stream()` generator:透過 `run_in_executor` 執行 `cap.read()` 和 `model.track()`,避免阻塞事件迴圈
   - 整合 `DistanceCalculator` 計算每個 `track_id` 的距離(含平滑化)
   - 實作 `start_detector()` / `stop_detector()` 控制攝影機生命週期
   - 回傳格式:`{"detections": [...], "fps": int, "closest_distance": float, "total_count": int, "timestamp": float}`

3. **建立 WebSocket 連線管理** - `app/services/connection_manager.py`:
   - `ConnectionManager` 類別管理活躍連線列表
   - `connect()` 方法:接受連線,若為首個連線則啟動偵測器
   - `disconnect()` 方法:移除連線,若列表清空則停止偵測器
   - `broadcast()` 方法:向所有連線推送資料,自動處理失敗連線
   - 從 `network_config.json` 讀取 `broadcast_interval` 控制推送頻率

4. **實作 API 端點** - `app/api/`:
   - **WebSocket** (`websocket.py`):
     - `WS /ws/detection` - 偵測串流 (後台監控用)
     - `WS /ws/live` - 簡化版串流 (前端作品用,只含 distance 和 count)
   - **RESTful** (`frontend.py`):
     - `GET /api/distance/current` - 最新距離資料快照
     - `GET /api/detection/stats` - 當前統計 (人數/距離/FPS)
     - `GET /api/network-config` - 取得網路配置
     - `PUT /api/network-config` - 更新網路配置並儲存至 `network_config.json`
     - `POST /api/detector/refresh` - 手動重啟偵測器(讀取最新 config)

5. **開發管理後台** - `admin/index.html`:
   - **即時監控區**:顯示當前偵測人數、最近距離(含顏色標示:>300綠/<150紅)、FPS(目標/實際)、運行時間
   - **網路設定區**:表單編輯 `broadcast_interval`(ms)、`websocket_port`、`websocket_host`,呼叫 `PUT /api/network-config` 儲存
   - **控制區**:「刷新連線」按鈕重新建立 WebSocket、「重啟偵測器」按鈕呼叫 `/api/detector/refresh`
   - 使用原生 JavaScript WebSocket,斷線時顯示警告不自動重連(需手動刷新)

6. **配置檔案設計**:
   - **`configs/config.json`** (複用現有):完整的 YOLO 和距離參數,由 GUI 工具調整
   - **`configs/network_config.json`** (新增):
     ```json
     {
       "websocket": {
         "host": "0.0.0.0",
         "port": 8000,
         "broadcast_interval": 33
       }
     }
     ```

7. **文件與範例** - `README.md`:
   - **校準流程**:使用 camera_test_gui_v2.py 進行焦距校準並儲存
   - **啟動指令**:`uvicorn app.main:app --reload --host 0.0.0.0 --port 8000`
   - **後台網址**:`http://localhost:8000/admin`
   - **前端串接範例**:
     - WebSocket 訂閱程式碼片段
     - REST API 呼叫範例
     - 回傳資料 JSON Schema 說明

**驗收標準:**
- 後台可即時顯示偵測數據,無延遲
- 修改 `network_config.json` 後手動刷新連線可生效
- 前端 API 回傳資料格式一致且包含完整 timestamp
- 偵測器在無連線時自動停止釋放資源
- 本地環境 `localhost:8000` 可正常運作