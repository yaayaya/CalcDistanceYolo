# 距離為 0 的離開機制修正

## 問題描述

在原始實作中,偵測有效性的判斷條件為:
```javascript
if (personCount > 0 && receivedDistance > 0)
```

這導致一個問題:
- **當距離變成 0,但仍偵測到人數時** (例如 `distance=0, count=1`)
- 系統不會觸發「離開機制」
- 模糊效果會持續保持,不會平滑恢復清晰

## 修正方案

### 修正前的邏輯
```javascript
// ❌ 問題: 只檢查 personCount > 0
if (personCount > 0 && receivedDistance > 0) {
    // 有效偵測
} else {
    // 無效偵測
}
```

### 修正後的邏輯
```javascript
// ✅ 修正: 必須同時滿足 distance > 0 AND count > 0
const hasValidDetection = receivedDistance > 0 && personCount > 0;

if (hasValidDetection) {
    // 有效偵測
} else {
    // 無效偵測 - 觸發離開機制
}
```

## 實際案例

### 案例 A: 正常離開
```
狀態: distance=75, count=1  → distance=0, count=0
結果: ✅ 正確觸發離開機制
```

### 案例 B: 距離計算失效 (修正前的問題)
```
狀態: distance=75, count=1  → distance=0, count=1
修正前: ❌ 不觸發離開機制 (因為 count > 0)
修正後: ✅ 正確觸發離開機制 (因為 distance = 0)
```

### 案例 C: 人數計算失效
```
狀態: distance=75, count=1  → distance=75, count=0
結果: ✅ 正確觸發離開機制
```

## 為什麼距離會變成 0?

可能的原因:
1. **距離計算失敗**: 無法計算出有效的距離值
2. **人物過近或過遠**: 超出有效偵測範圍
3. **人物姿態問題**: 身體部位偵測不完整
4. **遮擋或誤判**: 雖然偵測到人,但無法定位關鍵點
5. **系統保護機制**: 後端將無效距離設為 0

## 修正的檔案

### 1. flur_optimized.js (完整版)
- 修正 `handleDistanceData()` 函式
- 加入 `hasValidDetection` 判斷
- 增強除錯資訊顯示

### 2. flur.html (精簡版)
- 同步修正內嵌的 `handleDistanceData()` 函式
- 保持與完整版邏輯一致

### 3. test_smooth_blur.html (測試工具)
- 同步修正測試邏輯
- 加入新測試場景: "距離變0但人數保持"

## 測試驗證

### 使用測試工具驗證

1. 開啟 `test_smooth_blur.html`
2. 點擊「⚠️ 距離變0 (人數保持)」按鈕
3. 觀察行為:
   - 2 秒後距離變成 0,人數保持 1
   - 應該觸發離開機制 (等待 750ms 延遲)
   - 模糊效果開始平滑恢復清晰

### 預期結果

```
[時間] 📍 場景: 距離變0但人數保持 (測試修正)
[時間] ✅ 偵測啟動
[時間+2s] ⚠️ 距離變0,人數=1 (應觸發離開機制)
[時間+2.75s] ⏸ 偵測停用 - 開始恢復清晰
```

### 在實際系統中測試

1. 啟動後端: `python backend/main.py`
2. 開啟前端: `http://localhost:8000/flur.html`
3. 按 `Ctrl+Shift+D` 開啟除錯模式
4. 測試場景:
   - 站在攝影機前 (正常偵測)
   - 做出讓距離計算失效的動作 (例如側身、蹲下)
   - 觀察當 distance=0 時是否正確觸發離開機制

## 除錯資訊解讀

### 修正後的除錯顯示
```
距離: 0.0 → 65.3 cm 🟢 啟用 ✗
      ↑        ↑      ↑      ↑
   接收距離  平滑距離 狀態  有效性
```

**有效性指示器:**
- `✓`: 有效偵測 (distance > 0 AND count > 0)
- `✗`: 無效偵測 (distance = 0 OR count = 0)

## 技術細節

### 判斷邏輯流程圖

```
接收資料: distance, count
    ↓
hasValidDetection = (distance > 0) AND (count > 0)
    ↓
    ├─ TRUE  → 更新 lastValidDetectionTime
    │          檢查是否需啟動 (ACTIVATION_DELAY)
    │          更新 targetDistance = receivedDistance
    │
    └─ FALSE → 檢查 timeSinceLastValid
               ├─ >= DEACTIVATION_DELAY
               │  → 停用偵測
               │  → targetDistance = 0
               │  → 開始平滑恢復
               │
               └─ < DEACTIVATION_DELAY
                  → 保持當前 targetDistance
                  → 延遲期間模糊不變
```

## 優點與效果

### ✅ 優點
1. **更穩健**: 不會因為部分資料異常而卡住
2. **邏輯一致**: 任何無效狀態都觸發離開機制
3. **使用者體驗**: 避免模糊效果無法恢復的情況
4. **易於除錯**: 清楚顯示有效性狀態

### 🎯 實際效果
- 當後端距離計算失效時,前端會正確處理
- 避免「有人但沒距離」導致的畫面凍結
- 保持平滑過渡的視覺體驗

## 相關參數

這次修正不影響現有參數,仍可調整:

```json
{
  "blur_control": {
    "activation_delay": 200,      // 啟動延遲
    "deactivation_delay": 750     // 停用延遲
  },
  "distance_smoothing": {
    "smooth_speed": 0.15,          // 平滑速度
    "change_threshold": 10         // 變化閾值
  }
}
```

## 總結

此次修正確保了**距離為 0 時也會觸發離開機制**,無論人數偵測狀態如何。這讓系統更加穩健,避免因為部分資料異常導致的視覺效果卡住問題。

**核心改變**: 從「有人就繼續」改為「有人且有距離才繼續」。

---

**修正日期**: 2025年11月9日  
**相關文件**: `docs/平滑模糊使用指南.md`, `docs/平滑模糊轉移功能說明.md`
