<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlurPaint - äº’å‹•è—è¡“è£ç½®</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; width: 100vw; height: 100vh; }
        #canvas-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; overflow: hidden; }
        #video-source { display: none; }
        #display-canvas { position: fixed; top: 0; left: 0; width: 100vw !important; height: 100vh !important; object-fit: cover; transform: translateZ(0); }
        #debug-overlay { position: fixed; top: 20px; left: 20px; background: rgba(0, 0, 0, 0.8); color: #0f0; padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; border-radius: 8px; z-index: 1000; display: none; }
        #debug-overlay.active { display: block; }
        #debug-overlay .debug-item { margin: 5px 0; }
        #debug-overlay .debug-label { color: #0ff; }
        #debug-overlay .debug-value { color: #fff; font-weight: bold; }
        #connection-status { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: bold; z-index: 1000; display: none; }
        #connection-status.connecting { background: #f59e0b; color: #fff; display: block; }
        #connection-status.connected { background: #10b981; color: #fff; display: block; animation: fadeOut 2s forwards; }
        #connection-status.disconnected { background: #ef4444; color: #fff; display: block; }
        @keyframes fadeOut { 0%, 80% { opacity: 1; } 100% { opacity: 0; } }
        #exhibition-info { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); color: #fff; padding: 15px 30px; border-radius: 30px; font-size: 18px; text-align: center; z-index: 1000; animation: pulse 2s infinite; display: none; }
        #exhibition-info.active { display: block; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; color: #fff; }
        #loading-overlay.hidden { display: none; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-overlay"><div class="spinner"></div><p>æ­£åœ¨åˆå§‹åŒ–æ”å½±æ©Ÿ...</p></div>
    <div id="canvas-container"><video id="video-source" autoplay playsinline></video><canvas id="display-canvas"></canvas></div>
    <div id="debug-overlay">
        <div class="debug-item"><span class="debug-label">é€£ç·šç‹€æ…‹:</span> <span class="debug-value" id="debug-connection">æœªé€£ç·š</span></div>
        <div class="debug-item"><span class="debug-label">æ”å½±æ©Ÿ:</span> <span class="debug-value" id="debug-camera">æœªå•Ÿå‹•</span></div>
        <div class="debug-item"><span class="debug-label">åµæ¸¬è·é›¢:</span> <span class="debug-value" id="debug-distance">-- cm</span></div>
        <div class="debug-item"><span class="debug-label">åµæ¸¬äººæ•¸:</span> <span class="debug-value" id="debug-count">0</span></div>
        <div class="debug-item"><span class="debug-label">å½±æ ¼è§£æåº¦:</span> <span class="debug-value" id="debug-resolution">-- x --</span></div>
        <div class="debug-item"><span class="debug-label">FPS:</span> <span class="debug-value" id="debug-fps">--</span></div>
        <div class="debug-item"><span class="debug-label">æ¨¡ç³ŠåŠå¾‘:</span> <span class="debug-value" id="debug-blur">--</span></div>
        <div class="debug-item"><span class="debug-label">åœ–å±¤é€æ˜åº¦:</span> <span class="debug-value" id="debug-opacity">--</span></div>
    </div>
    <div id="connection-status">é€£ç·šä¸­...</div>
    <div id="exhibition-info">è«‹é è¿‘æˆ–é é›¢æ„Ÿæ‡‰å™¨,é«”é©—å½±åƒè§£æåº¦çš„è®ŠåŒ–</div>
    <script>
// FlurPaint å‰ç«¯ - ä½¿ç”¨ getUserMedia API ç›´æ¥å–å¾—æ”å½±æ©Ÿç•«é¢
// åƒ…æ¥æ”¶å¾Œç«¯è·é›¢è³‡æ–™ï¼Œå¤§å¹…æå‡æ•ˆèƒ½

let ws=null,config=null,canvas=null,ctx=null,video=null,stream=null,animationFrameId=null;
let currentDistance=0,targetDistance=0,smoothedDistance=0,currentBlurRadius=0,currentOpacity=0;
let DISTANCE_SMOOTH_SPEED=.15,DISTANCE_CHANGE_THRESHOLD=10;
let frameCount=0,lastFpsUpdate=performance.now(),currentFps=0;

document.addEventListener('DOMContentLoaded',async()=>{
    canvas=document.getElementById('display-canvas');
    ctx=canvas.getContext('2d',{alpha:false,willReadFrequently:false});
    video=document.getElementById('video-source');
    await loadConfig();
    applyDisplaySettings();
    await initCamera();
    connectWebSocket();
    bindHotkeys();
});

async function loadConfig(){
    try{
        const response=await fetch('/api/project-config');
        const result=await response.json();
        if(result.status==='success'){
            config=result.data;
            if(config.distance_smoothing){
                DISTANCE_SMOOTH_SPEED=config.distance_smoothing.smooth_speed||.15;
                DISTANCE_CHANGE_THRESHOLD=config.distance_smoothing.change_threshold||10;
            }
            console.log('âœ… é…ç½®å·²è¼‰å…¥');
        }else{useDefaultConfig();}
    }catch(error){
        console.error('âŒ è¼‰å…¥é…ç½®éŒ¯èª¤:',error);
        useDefaultConfig();
    }
}

function useDefaultConfig(){
    config={
        distance_mapping:{min_distance:50,max_distance:500,easing_function:"linear"},
        display:{debug_mode:false,exhibition_mode:true},
        flur_streaming:{enable_dynamic_resolution:true,min_resolution_scale:0.3,max_resolution_scale:1.0,enable_dynamic_quality:false,jpeg_quality:70,min_jpeg_quality:30,max_jpeg_quality:85,max_fps:30,frame_skip:1},
        blur_overlay:{enabled:false,min_distance:70,max_distance:120,min_blur_radius:0,max_blur_radius:8,min_opacity:0,max_opacity:.3,overlay_color:"#888888",easing_function:"ease-out",layer_count:3,blend_mode:"normal"},
        canvas_filter:{enabled:true,min_distance:70,max_distance:120,min_blur_radius:0,max_blur_radius:5,easing_function:"ease-out",noise_enabled:true,min_noise_intensity:0,max_noise_intensity:.08,noise_blend_mode:"overlay"},
        distance_smoothing:{enabled:true,smooth_speed:.15,change_threshold:10}
    };
}

async function initCamera(){
    try{
        const cameraResponse=await fetch('/api/camera-selection');
        const cameraResult=await cameraResponse.json();
        let cameraId=0;
        if(cameraResult.status==='success'){
            cameraId=cameraResult.data.selected_camera||0;
            console.log(`ğŸ“¹ ä½¿ç”¨æ”å½±æ©Ÿ: ${cameraId}`);
            updateDebugInfo('camera',`æ”å½±æ©Ÿ ${cameraId}`);
        }
        const devices=await navigator.mediaDevices.enumerateDevices();
        const videoDevices=devices.filter(device=>device.kind==='videoinput');
        console.log('ğŸ“¹ å¯ç”¨æ”å½±æ©Ÿ:',videoDevices);
        if(cameraId>=videoDevices.length){
            console.warn(`âš  æ”å½±æ©Ÿ ${cameraId} ä¸å­˜åœ¨,ä½¿ç”¨é è¨­æ”å½±æ©Ÿ`);
            cameraId=0;
        }
        const constraints={
            video:{
                deviceId:videoDevices[cameraId]?.deviceId?{exact:videoDevices[cameraId].deviceId}:undefined,
                width:{ideal:1920},
                height:{ideal:1080},
                frameRate:{ideal:30}
            },
            audio:false
        };
        stream=await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject=stream;
        await new Promise((resolve)=>{
            video.onloadedmetadata=()=>{
                console.log(`âœ… æ”å½±æ©Ÿå·²å•Ÿå‹•: ${video.videoWidth}x${video.videoHeight}`);
                updateDebugInfo('camera',`${cameraId} (${video.videoWidth}x${video.videoHeight})`);
                resolve();
            };
        });
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        updateDebugInfo('resolution',`${canvas.width} x ${canvas.height}`);
        document.getElementById('loading-overlay').classList.add('hidden');
        startRenderLoop();
    }catch(error){
        console.error('âŒ æ”å½±æ©Ÿå•Ÿå‹•å¤±æ•—:',error);
        alert('ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼Œè«‹ç¢ºèªæ¬Šé™è¨­å®š');
        document.getElementById('loading-overlay').querySelector('p').textContent='æ”å½±æ©Ÿå•Ÿå‹•å¤±æ•—';
    }
}

function applyDisplaySettings(){
    const debugOverlay=document.getElementById('debug-overlay');
    const exhibitionInfo=document.getElementById('exhibition-info');
    if(config.display.debug_mode){
        debugOverlay.classList.add('active');
        exhibitionInfo.classList.remove('active');
    }else if(config.display.exhibition_mode){
        debugOverlay.classList.remove('active');
        exhibitionInfo.classList.add('active');
    }else{
        debugOverlay.classList.remove('active');
        exhibitionInfo.classList.remove('active');
    }
}

function connectWebSocket(){
    const protocol=window.location.protocol==='https:'?'wss:':'ws:';
    const wsUrl=`${protocol}//${window.location.host}/ws/flur`;
    updateConnectionUI('connecting');
    try{
        ws=new WebSocket(wsUrl);
        ws.onopen=()=>{
            console.log('âœ… WebSocket å·²é€£ç·š');
            updateConnectionUI('connected');
            updateDebugInfo('connection','å·²é€£ç·š');
        };
        ws.onmessage=(event)=>{
            const data=JSON.parse(event.data);
            handleDistanceData(data);
        };
        ws.onerror=(error)=>{
            console.error('âŒ WebSocket éŒ¯èª¤:',error);
            updateConnectionUI('disconnected');
        };
        ws.onclose=()=>{
            console.log('â¹ WebSocket å·²æ–·ç·š');
            updateConnectionUI('disconnected');
            setTimeout(connectWebSocket,5000);
        };
    }catch(error){
        console.error('âŒ å»ºç«‹ WebSocket å¤±æ•—:',error);
        updateConnectionUI('disconnected');
    }
}

function handleDistanceData(data){
    if(data.type!=='distance_data')return;
    targetDistance=data.distance||0;
    if(smoothedDistance===0)smoothedDistance=targetDistance;
    const distanceDiff=Math.abs(targetDistance-smoothedDistance);
    if(distanceDiff>DISTANCE_CHANGE_THRESHOLD){
        smoothedDistance+=(targetDistance-smoothedDistance)*DISTANCE_SMOOTH_SPEED;
    }else{
        smoothedDistance=targetDistance;
    }
    currentDistance=smoothedDistance;
    updateDebugInfo('distance',`${targetDistance.toFixed(1)} cm â†’ ${smoothedDistance.toFixed(1)} cm`);
    updateDebugInfo('count',data.total_count||0);
}

function startRenderLoop(){
    function render(){
        drawFrame();
        frameCount++;
        const now=performance.now();
        const elapsed=now-lastFpsUpdate;
        if(elapsed>=1000){
            currentFps=Math.round((frameCount*1000)/elapsed);
            frameCount=0;
            lastFpsUpdate=now;
            updateDebugInfo('fps',currentFps);
        }
        animationFrameId=requestAnimationFrame(render);
    }
    render();
}

function drawFrame(){
    if(!video||video.readyState<2)return;
    
    // è—è¡“æ•ˆæœï¼šå‹•æ…‹è§£æåº¦
    let targetWidth=canvas.width;
    let targetHeight=canvas.height;
    if(config.flur_streaming&&config.flur_streaming.enable_dynamic_resolution){
        const normalizedDistance=calculateNormalizedDistance(currentDistance,config.distance_mapping.min_distance,config.distance_mapping.max_distance);
        const minScale=config.flur_streaming.min_resolution_scale||0.3;
        const maxScale=config.flur_streaming.max_resolution_scale||1.0;
        const resolutionScale=lerp(minScale,maxScale,normalizedDistance);
        targetWidth=Math.floor(canvas.width*resolutionScale);
        targetHeight=Math.floor(canvas.height*resolutionScale);
        updateDebugInfo('resolution',`${targetWidth} x ${targetHeight} (${(resolutionScale*100).toFixed(0)}%)`);
    }
    
    // å»ºç«‹è‡¨æ™‚ canvas ç”¨æ–¼é™ä½è§£æåº¦
    const tempCanvas=document.createElement('canvas');
    tempCanvas.width=targetWidth;
    tempCanvas.height=targetHeight;
    const tempCtx=tempCanvas.getContext('2d',{alpha:false});
    
    // ç¹ªè£½åˆ°è‡¨æ™‚ canvasï¼ˆé™ä½è§£æåº¦ï¼‰
    if(config.canvas_filter&&config.canvas_filter.enabled){
        const filterConfig=config.canvas_filter;
        const normalizedDistance=calculateNormalizedDistance(currentDistance,filterConfig.min_distance,filterConfig.max_distance);
        const easedValue=applyEasing(normalizedDistance,filterConfig.easing_function||'ease-out');
        const blurRadius=lerp(filterConfig.max_blur_radius,filterConfig.min_blur_radius,easedValue);
        if(blurRadius>0)tempCtx.filter=`blur(${blurRadius}px)`;
        tempCtx.drawImage(video,0,0,targetWidth,targetHeight);
        tempCtx.filter='none';
        updateDebugInfo('blur',`Canvas Filter: ${blurRadius.toFixed(1)} px`);
    }else{
        tempCtx.drawImage(video,0,0,targetWidth,targetHeight);
    }
    
    // è—è¡“æ•ˆæœï¼šå‹•æ…‹ JPEG å“è³ªï¼ˆé€é canvas å£“ç¸®é‡ç¹ªï¼‰
    if(config.flur_streaming&&config.flur_streaming.enable_dynamic_quality){
        const normalizedDistance=calculateNormalizedDistance(currentDistance,config.distance_mapping.min_distance,config.distance_mapping.max_distance);
        const minQuality=config.flur_streaming.min_jpeg_quality||30;
        const maxQuality=config.flur_streaming.max_jpeg_quality||85;
        const quality=lerp(minQuality,maxQuality,normalizedDistance)/100;
        
        // é€é JPEG å£“ç¸®å’Œè§£å£“ç¸®ç”¢ç”Ÿå¤±çœŸæ•ˆæœ
        const dataUrl=tempCanvas.toDataURL('image/jpeg',quality);
        const img=new Image();
        img.onload=()=>{
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.imageSmoothingEnabled=false;
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            if(config.canvas_filter&&config.canvas_filter.noise_enabled){
                const filterConfig=config.canvas_filter;
                const normalizedDistance=calculateNormalizedDistance(currentDistance,filterConfig.min_distance,filterConfig.max_distance);
                const easedValue=applyEasing(normalizedDistance,filterConfig.easing_function||'ease-out');
                const noiseIntensity=lerp(filterConfig.max_noise_intensity,filterConfig.min_noise_intensity,easedValue);
                if(noiseIntensity>0)drawNoiseLayer(noiseIntensity,filterConfig.noise_blend_mode||'overlay');
            }
            if(config.blur_overlay&&config.blur_overlay.enabled){
                drawBlurOverlay();
            }
        };
        img.src=dataUrl;
    }else{
        // ä¸ä½¿ç”¨ JPEG å£“ç¸®ï¼Œç›´æ¥æ”¾å¤§ç¹ªè£½
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.imageSmoothingEnabled=false;
        ctx.drawImage(tempCanvas,0,0,canvas.width,canvas.height);
        
        if(config.canvas_filter&&config.canvas_filter.noise_enabled){
            const filterConfig=config.canvas_filter;
            const normalizedDistance=calculateNormalizedDistance(currentDistance,filterConfig.min_distance,filterConfig.max_distance);
            const easedValue=applyEasing(normalizedDistance,filterConfig.easing_function||'ease-out');
            const noiseIntensity=lerp(filterConfig.max_noise_intensity,filterConfig.min_noise_intensity,easedValue);
            if(noiseIntensity>0)drawNoiseLayer(noiseIntensity,filterConfig.noise_blend_mode||'overlay');
        }
        
        if(config.blur_overlay&&config.blur_overlay.enabled){
            drawBlurOverlay();
        }
    }
}

function drawBlurOverlay(){
    const overlay=config.blur_overlay;
    const normalizedDistance=calculateNormalizedDistance(currentDistance,overlay.min_distance,overlay.max_distance);
    const easedValue=applyEasing(normalizedDistance,overlay.easing_function);
    currentBlurRadius=lerp(overlay.max_blur_radius,overlay.min_blur_radius,easedValue);
    currentOpacity=lerp(overlay.max_opacity,overlay.min_opacity,easedValue);
    updateDebugInfo('blur',`${currentBlurRadius.toFixed(1)} px`);
    updateDebugInfo('opacity',`${(currentOpacity*100).toFixed(1)}%`);
    if(currentBlurRadius>0&&currentOpacity>0){
        const layerCount=overlay.layer_count||3;
        const opacityPerLayer=currentOpacity/layerCount;
        for(let i=0;i<layerCount;i++){
            ctx.save();
            ctx.globalCompositeOperation=overlay.blend_mode||'normal';
            ctx.globalAlpha=opacityPerLayer;
            const blurPerLayer=currentBlurRadius*(1-i/layerCount*.3);
            ctx.filter=`blur(${blurPerLayer}px)`;
            ctx.fillStyle=overlay.overlay_color||'#888888';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.restore();
        }
        ctx.filter='none';
        ctx.globalAlpha=1.0;
        ctx.globalCompositeOperation='source-over';
    }
}

let noiseCanvas=null,noiseCtx=null;
function drawNoiseLayer(intensity,blendMode){
    if(!noiseCanvas||noiseCanvas.width!==canvas.width||noiseCanvas.height!==canvas.height){
        noiseCanvas=document.createElement('canvas');
        noiseCanvas.width=canvas.width;
        noiseCanvas.height=canvas.height;
        noiseCtx=noiseCanvas.getContext('2d',{alpha:false});
    }
    const scale=.5;
    const noiseData=noiseCtx.createImageData(canvas.width*scale,canvas.height*scale);
    const pixels=noiseData.data;
    const intensityValue=255*intensity;
    for(let i=0;i<pixels.length;i+=4){
        const noise=(Math.random()-.5)*intensityValue;
        const gray=128+noise;
        pixels[i]=gray;
        pixels[i+1]=gray;
        pixels[i+2]=gray;
        pixels[i+3]=255;
    }
    noiseCtx.putImageData(noiseData,0,0);
    ctx.save();
    ctx.globalCompositeOperation=blendMode;
    ctx.drawImage(noiseCanvas,0,0,canvas.width,canvas.height);
    ctx.restore();
    ctx.globalCompositeOperation='source-over';
}

function calculateNormalizedDistance(distance,minDist,maxDist){
    if(distance<=minDist)return 0;
    if(distance>=maxDist)return 1;
    return(distance-minDist)/(maxDist-minDist);
}

function applyEasing(t,easingType){
    switch(easingType){
        case 'linear':return t;
        case 'ease-in':return t*t;
        case 'ease-out':return 1-Math.pow(1-t,2);
        case 'ease-in-out':return t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;
        default:return t;
    }
}

function lerp(start,end,t){
    return start+(end-start)*t;
}

function updateConnectionUI(status){
    const statusElement=document.getElementById('connection-status');
    statusElement.className=status;
    const statusText={'connecting':'é€£ç·šä¸­...','connected':'å·²é€£ç·š','disconnected':'é€£ç·šä¸­æ–·'};
    statusElement.textContent=statusText[status]||'æœªçŸ¥ç‹€æ…‹';
}

function updateDebugInfo(key,value){
    const element=document.getElementById(`debug-${key}`);
    if(element)element.textContent=value;
}

function bindHotkeys(){
    document.addEventListener('keydown',(e)=>{
        if(e.ctrlKey&&e.shiftKey&&e.key==='D'){
            config.display.debug_mode=!config.display.debug_mode;
            applyDisplaySettings();
            e.preventDefault();
        }
        if(e.ctrlKey&&e.shiftKey&&e.key==='E'){
            config.display.exhibition_mode=!config.display.exhibition_mode;
            applyDisplaySettings();
            e.preventDefault();
        }
    });
}

window.addEventListener('beforeunload',()=>{
    if(animationFrameId)cancelAnimationFrame(animationFrameId);
    if(stream)stream.getTracks().forEach(track=>track.stop());
    if(ws)ws.close();
});
    </script>
</body>
</html>
